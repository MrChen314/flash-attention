# TiledMMAçŸ©é˜µä¹˜æ³•

> cuteå¯¹Tensor Coreæ“ä½œçš„é«˜å±‚å°è£…

---

## 1. ä»€ä¹ˆæ˜¯TiledMMA

### 1.1 èƒŒæ™¯ï¼šTensor Core

NVIDIA Tensor Coreæ˜¯ä¸“é—¨ç”¨äºçŸ©é˜µä¹˜ç´¯åŠ ï¼ˆMMAï¼‰è¿ç®—çš„ç¡¬ä»¶å•å…ƒï¼š

```
Tensor Core MMAæ“ä½œ:
D = A Ã— B + C

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  A      â”‚ Ã— â”‚    B    â”‚ + â”‚    C    â”‚ = â”‚    D    â”‚
â”‚ (MÃ—K)   â”‚   â”‚  (KÃ—N)  â”‚   â”‚  (MÃ—N)  â”‚   â”‚  (MÃ—N)  â”‚
â”‚ FP16    â”‚   â”‚  FP16   â”‚   â”‚ FP32    â”‚   â”‚ FP32    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SM80 (Ampere) Tensor Coreæ”¯æŒçš„MMAå¤§å°:
- 16Ã—8Ã—16 (M=16, N=8, K=16)
- 16Ã—8Ã—8
- ç­‰ç­‰...
```

### 1.2 TiledMMAå®šä¹‰

**TiledMMA**æ˜¯cuteå¯¹Tensor Core MMAæ“ä½œçš„æŠ½è±¡å°è£…ï¼Œå®ƒå®šä¹‰äº†ï¼š

1. **MMA Atom**ï¼šå•ä¸ªTensor CoreæŒ‡ä»¤çš„è§„æ ¼
2. **Atom Layout**ï¼šå¤šä¸ªMMA Atomå¦‚ä½•åœ¨çº¿ç¨‹é—´åˆ†å¸ƒ
3. **Value Layout**ï¼šæ¯ä¸ªçº¿ç¨‹å¤„ç†å“ªäº›æ•°æ®å…ƒç´ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TiledMMA ç»“æ„                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   TiledMMA = MMA_Atom + AtomLayout + ValueLayout                â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚   â”‚   MMA Atom   â”‚  å•ä¸ªTensor CoreæŒ‡ä»¤                         â”‚
â”‚   â”‚              â”‚  ä¾‹: SM80_16x8x16_F32F16F16F32_TN            â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â” â”‚  - è¾“å…¥: 16Ã—16 FP16 (A) Ã— 16Ã—8 FP16 (B)     â”‚
â”‚   â”‚  â”‚ A  â”‚ B  â”‚ â”‚  - è¾“å‡º: 16Ã—8 FP32 (C)                       â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜ â”‚  - 32ä¸ªçº¿ç¨‹åä½œå®Œæˆ                          â”‚
â”‚   â”‚      â†“       â”‚                                              â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                              â”‚
â”‚   â”‚  â”‚   C    â”‚  â”‚                                              â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚          â†“                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚   â”‚  AtomLayout  â”‚  å¤šä¸ªAtomå¦‚ä½•æ’åˆ—                            â”‚
â”‚   â”‚              â”‚  ä¾‹: Shape<_2, _2, _1>                       â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â” â”‚  - 2Ã—2 = 4ä¸ªAtom                            â”‚
â”‚   â”‚  â”‚ A0 â”‚ A1 â”‚ â”‚  - è¦†ç›–æ›´å¤§çš„çŸ©é˜µåŒºåŸŸ                        â”‚
â”‚   â”‚  â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤ â”‚                                              â”‚
â”‚   â”‚  â”‚ A2 â”‚ A3 â”‚ â”‚                                              â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜ â”‚                                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚          â†“                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚   â”‚  ValueLayout â”‚  æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å€¼                            â”‚
â”‚   â”‚              â”‚  å®šä¹‰æ•°æ®å¦‚ä½•æ˜ å°„åˆ°çº¿ç¨‹                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. MMA Atomè¯¦è§£

### 2.1 SM80 MMAæŒ‡ä»¤

Ampereæ¶æ„(SM80)æ”¯æŒå¤šç§MMAæŒ‡ä»¤ï¼š

| MMAç±»å‹ | M | N | K | è¾“å…¥ç²¾åº¦ | è¾“å‡ºç²¾åº¦ |
|---------|---|---|---|----------|----------|
| SM80_16x8x16_F32F16F16F32_TN | 16 | 8 | 16 | FP16 | FP32 |
| SM80_16x8x16_F32BF16BF16F32_TN | 16 | 8 | 16 | BF16 | FP32 |
| SM80_16x8x8_F32TF32TF32F32_TN | 16 | 8 | 8 | TF32 | FP32 |

### 2.2 å‘½åè§„åˆ™

```cpp
SM80_16x8x16_F32F16F16F32_TN
â”‚    â”‚      â”‚           â”‚
â”‚    â”‚      â”‚           â””â”€â”€ T: Aè½¬ç½®, N: Bä¸è½¬ç½®
â”‚    â”‚      â””â”€â”€ ç²¾åº¦: D=F32, A=F16, B=F16, C=F32
â”‚    â””â”€â”€ MxNxK: 16Ã—8Ã—16
â””â”€â”€ æ¶æ„: SM80 (Ampere)
```

### 2.3 ä»£ç ç¤ºä¾‹

```cpp
#include <cute/atom/mma_atom.hpp>

// å®šä¹‰MMA Atom
using MmaAtom = MMA_Atom<SM80_16x8x16_F32F16F16F32_TN>;

// æŸ¥çœ‹Atomå±æ€§
print(MmaAtom{});
// è¾“å‡ºç±»ä¼¼: MMA_Atom 16x8x16
```

---

## 3. åˆ›å»ºTiledMMA

### 3.1 åŸºæœ¬åˆ›å»ºæ–¹å¼

```cpp
#include <cute/atom/mma_atom.hpp>

using namespace cute;

// æ–¹å¼1: ä½¿ç”¨make_tiled_mma
auto tiled_mma = make_tiled_mma(
    SM80_16x8x16_F32F16F16F32_TN{},  // MMA Atom
    Layout<Shape<_2, _2, _1>>{},      // Atomå¸ƒå±€: 2Ã—2ä¸ªAtom
    Tile<_32, _32, _16>{}             // æ¯ä¸ªTileçš„MNKå¤§å°
);

// æ–¹å¼2: ä½¿ç”¨ç±»å‹åˆ«å
using TiledMma = TiledMMA<
    MMA_Atom<SM80_16x8x16_F32F16F16F32_TN>,
    Layout<Shape<_2, _2, _1>>,
    Tile<_32, _32, _16>
>;
TiledMma tiled_mma;
```

### 3.2 Atom Layoutçš„æ„ä¹‰

```
AtomLayout = Shape<_2, _2, _1>

è¡¨ç¤º 2Ã—2Ã—1 = 4 ä¸ªMMA Atomçš„æ’åˆ—:

å•ä¸ªAtom: 16Ã—8 (MxN)

4ä¸ªAtomçš„æ’åˆ—:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â”‚
â”‚   Atom(0,0)    â”‚    Atom(0,1)        â”‚
â”‚   16Ã—8         â”‚    16Ã—8             â”‚
â”‚                â”‚                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚   Atom(1,0)    â”‚    Atom(1,1)        â”‚
â”‚   16Ã—8         â”‚    16Ã—8             â”‚
â”‚                â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»å¤§å°: M = 16Ã—2 = 32, N = 8Ã—2 = 16
```

---

## 4. ä½¿ç”¨TiledMMA

### 4.1 è·å–çº¿ç¨‹è§†å›¾

```cpp
// åœ¨kernelä¸­
__global__ void kernel() {
    TiledMma tiled_mma;
    
    // è·å–å½“å‰çº¿ç¨‹çš„MMAè§†å›¾
    auto thr_mma = tiled_mma.get_thread_slice(threadIdx.x);
    
    // æˆ–è€…ä½¿ç”¨get_sliceï¼ˆç­‰ä»·ï¼‰
    auto thr_mma2 = tiled_mma.get_slice(threadIdx.x);
}
```

### 4.2 partitionæ“ä½œ

partitionå°†Tensoråˆ†é…ç»™çº¿ç¨‹ï¼Œè¿”å›å½“å‰çº¿ç¨‹è´Ÿè´£çš„éƒ¨åˆ†ï¼š

```cpp
// å‡è®¾æœ‰å…±äº«å†…å­˜ä¸­çš„A, B, CçŸ©é˜µ
Tensor sA = ...;  // å…±äº«å†…å­˜ä¸­çš„A
Tensor sB = ...;  // å…±äº«å†…å­˜ä¸­çš„B
Tensor acc = ...; // å¯„å­˜å™¨ä¸­çš„ç´¯åŠ å™¨

auto thr_mma = tiled_mma.get_thread_slice(threadIdx.x);

// partition_A: è·å–å½“å‰çº¿ç¨‹è´Ÿè´£çš„Açš„éƒ¨åˆ†
Tensor tCrA = thr_mma.partition_A(sA);

// partition_B: è·å–å½“å‰çº¿ç¨‹è´Ÿè´£çš„Bçš„éƒ¨åˆ†
Tensor tCrB = thr_mma.partition_B(sB);

// partition_C: è·å–å½“å‰çº¿ç¨‹è´Ÿè´£çš„Cçš„éƒ¨åˆ†
Tensor tCrC = thr_mma.partition_C(acc);

// æ‰§è¡ŒçŸ©é˜µä¹˜æ³•
cute::gemm(tiled_mma, tCrA, tCrB, tCrC);
```

### 4.3 partitionçš„ç»“æœå½¢çŠ¶

```cpp
// partitionåçš„Tensorå½¢çŠ¶é€šå¸¸æ˜¯ (MMA, MMA_M, MMA_K) æˆ–ç±»ä¼¼

// ä¾‹å¦‚å¯¹äº TiledMMA<SM80_16x8x16, Layout<_2,_2,_1>>
// partition_A ç»“æœå¯èƒ½æ˜¯: ((4), (2), (2))
//   - 4: æ¯ä¸ªçº¿ç¨‹åœ¨ä¸€ä¸ªMMA Atomä¸­çš„å…ƒç´ æ•°
//   - 2: Mæ–¹å‘çš„Atomæ•°
//   - 2: Kæ–¹å‘çš„è¿­ä»£æ•°

// partition_C ç»“æœå¯èƒ½æ˜¯: ((4), (2), (2))
//   - 4: æ¯ä¸ªçº¿ç¨‹çš„ç´¯åŠ å™¨å…ƒç´ æ•°
//   - 2: Mæ–¹å‘
//   - 2: Næ–¹å‘
```

---

## 5. æ‰§è¡ŒGEMM

### 5.1 cute::gemmå‡½æ•°

```cpp
// åŸºæœ¬å½¢å¼
cute::gemm(tiled_mma, fragA, fragB, fragC);

// è¿™ä¼šæ‰§è¡Œ: fragC += fragA Ã— fragB

// å¸¦æ¸…é›¶é€‰é¡¹
cute::gemm</*zero_init=*/true>(tiled_mma, fragA, fragB, fragC);
// å…ˆå°†fragCæ¸…é›¶ï¼Œç„¶åç´¯åŠ 
```

### 5.2 å®Œæ•´GEMMå¾ªç¯

```cpp
// FlashAttentionä¸­çš„å…¸å‹æ¨¡å¼
// è®¡ç®— S = Q @ K^T

// 1. åˆå§‹åŒ–ç´¯åŠ å™¨
Tensor acc_s = partition_fragment_C(tiled_mma, Shape<Int<kBlockM>, Int<kBlockN>>{});
clear(acc_s);

// 2. ä»å…±äº«å†…å­˜åŠ è½½åˆ°å¯„å­˜å™¨
auto smem_thr_copy_A = smem_tiled_copy_A.get_thread_slice(threadIdx.x);
Tensor tCsQ = smem_thr_copy_A.partition_S(sQ);  // å…±äº«å†…å­˜Qçš„åˆ†åŒº
Tensor tCrQ = smem_thr_copy_A.retile_D(tCrQ_); // å¯„å­˜å™¨Qçš„åˆ†åŒº

// 3. Kå¾ªç¯
for (int k = 0; k < num_k_tiles; ++k) {
    // åŠ è½½Qå’ŒKçš„ä¸€ä¸ªK-tileåˆ°å¯„å­˜å™¨
    cute::copy(smem_tiled_copy_A, tCsQ(_, _, k), tCrQ(_, _, k));
    cute::copy(smem_tiled_copy_B, tCsK(_, _, k), tCrK(_, _, k));
    
    // æ‰§è¡ŒMMA
    cute::gemm(tiled_mma, tCrQ(_, _, k), tCrK(_, _, k), acc_s);
}

// 4. acc_s ç°åœ¨åŒ…å« S = Q @ K^T çš„ç»“æœ
```

---

## 6. åœ¨FlashAttentionä¸­çš„åº”ç”¨

### 6.1 è®¡ç®—S = QK^T

```cpp
// hopper/utils.h ä¸­çš„ gemm å‡½æ•°

template <bool zero_init=true, int wg_wait=0, bool SwapAB=false, int M_slice=-1,
          typename Tensor0, typename Tensor1, typename Tensor2, typename TiledMma>
CUTLASS_DEVICE void gemm(TiledMma& tiled_mma, 
                         Tensor0 const& tCrA, 
                         Tensor1 const& tCrB, 
                         Tensor2& tCrC) {
    // å¤„ç†SwapABçš„æƒ…å†µ
    if constexpr (!SwapAB) {
        cute::gemm(tiled_mma, tCrA, tCrB, tCrC);
    } else {
        cute::gemm(tiled_mma, tCrB, tCrA, tCrC);
    }
}
```

### 6.2 FlashAttentionçš„TiledMMAå®šä¹‰

```cpp
// å…¸å‹çš„FlashAttention TiledMMAé…ç½®

// ç”¨äºè®¡ç®— S = QK^T
using TiledMmaSdP = TiledMMA<
    MMA_Atom<SM80_16x8x16_F32F16F16F32_TN>,
    Layout<Shape<_2, _2, _1>>,   // 2x2 Atoms
    Tile<_32, _32, _16>
>;

// ç”¨äºè®¡ç®— O = PV
using TiledMmaOdO = TiledMMA<
    MMA_Atom<SM80_16x8x16_F32F16F16F32_TN>,
    Layout<Shape<_2, _2, _1>>,
    Tile<_32, _64, _16>  // Vçš„Nç»´åº¦å¯èƒ½ä¸åŒ
>;
```

### 6.3 çº¿ç¨‹åˆ°æ•°æ®çš„æ˜ å°„

```
TiledMMAçº¿ç¨‹æ˜ å°„ç¤ºæ„:

ä¸€ä¸ªWarp (32çº¿ç¨‹) æ‰§è¡Œ 16Ã—8Ã—16 MMA:

çº¿ç¨‹0-31çš„æ•°æ®åˆ†é…:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AçŸ©é˜µ (16Ã—16)                       â”‚
â”‚  T0  T1  T2  T3  T4  T5  T6  T7 â”‚ ...           â”‚
â”‚  T0  T1  T2  T3  T4  T5  T6  T7 â”‚               â”‚
â”‚  T8  T9  T10 T11 T12 T13 T14 T15â”‚               â”‚
â”‚  T8  T9  T10 T11 T12 T13 T14 T15â”‚               â”‚
â”‚  ...                             â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªçº¿ç¨‹æŒæœ‰Açš„å¤šä¸ªå…ƒç´ ï¼ˆFragmentï¼‰
partition_A è¿”å›è¿™äº›å…ƒç´ çš„è§†å›¾
```

---

## 7. è°ƒè¯•æŠ€å·§

### 7.1 æ‰“å°TiledMMAä¿¡æ¯

```cpp
TiledMma tiled_mma;
print(tiled_mma);

// è¾“å‡ºç±»ä¼¼:
// TiledMMA
//   AtomMNK: (16,8,16)
//   AtomLayout_MNK: (2,2,1)
//   ValLayout_MNK: ...
```

### 7.2 æ£€æŸ¥åˆ†åŒºå½¢çŠ¶

```cpp
auto thr_mma = tiled_mma.get_thread_slice(threadIdx.x);

Tensor tCrA = thr_mma.partition_A(sA);
Tensor tCrB = thr_mma.partition_B(sB);
Tensor tCrC = thr_mma.partition_C(acc);

if (threadIdx.x == 0) {
    print("tCrA: "); print(tCrA.layout()); print("\n");
    print("tCrB: "); print(tCrB.layout()); print("\n");
    print("tCrC: "); print(tCrC.layout()); print("\n");
}
```

---

## 8. å…³é”®æœ¯è¯­

| æœ¯è¯­ | è‹±æ–‡ | å«ä¹‰ |
|------|------|------|
| MMA | Matrix Multiply-Accumulate | çŸ©é˜µä¹˜ç´¯åŠ  |
| Tensor Core | - | NVIDIAçš„çŸ©é˜µè®¡ç®—ç¡¬ä»¶å•å…ƒ |
| MMA Atom | - | å•ä¸ªTensor CoreæŒ‡ä»¤çš„æŠ½è±¡ |
| TiledMMA | - | å¤šä¸ªMMA Atomçš„ç»„åˆæŠ½è±¡ |
| partition_A/B/C | - | å°†çŸ©é˜µåˆ†é…ç»™çº¿ç¨‹çš„æ“ä½œ |
| Fragment | - | å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­çš„æ•°æ®ç‰‡æ®µ |
| Warp | - | 32ä¸ªçº¿ç¨‹çš„æ‰§è¡Œå•å…ƒ |

---

## 9. æ€»ç»“

### 9.1 TiledMMAçš„æ ¸å¿ƒä»·å€¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TiledMMA æ ¸å¿ƒä»·å€¼                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. å°è£…å¤æ‚æ€§                                                   â”‚
â”‚     â””â”€â”€ éšè—Tensor CoreæŒ‡ä»¤çš„ç»†èŠ‚                               â”‚
â”‚                                                                  â”‚
â”‚  2. è‡ªåŠ¨çº¿ç¨‹æ˜ å°„                                                 â”‚
â”‚     â””â”€â”€ partitionè‡ªåŠ¨è®¡ç®—æ¯ä¸ªçº¿ç¨‹è´Ÿè´£çš„æ•°æ®                     â”‚
â”‚                                                                  â”‚
â”‚  3. å¯ç»„åˆæ€§                                                     â”‚
â”‚     â””â”€â”€ ä¸åŒçš„Atom Layoutå¯ä»¥è¦†ç›–ä¸åŒå¤§å°çš„çŸ©é˜µ                 â”‚
â”‚                                                                  â”‚
â”‚  4. é«˜æ•ˆæ‰§è¡Œ                                                     â”‚
â”‚     â””â”€â”€ ç›´æ¥æ˜ å°„åˆ°ç¡¬ä»¶æŒ‡ä»¤ï¼Œæ— é¢å¤–å¼€é”€                          â”‚
â”‚                                                                  â”‚
â”‚  5. ä¸TiledCopyé…åˆ                                              â”‚
â”‚     â””â”€â”€ æ•°æ®æµï¼šGMEM â†’ SMEM â†’ Register â†’ MMA                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 ä½¿ç”¨æ¨¡å¼

```cpp
// å…¸å‹ä½¿ç”¨æµç¨‹:
// 1. å®šä¹‰TiledMMA
TiledMma tiled_mma = make_tiled_mma(...);

// 2. è·å–çº¿ç¨‹è§†å›¾
auto thr_mma = tiled_mma.get_thread_slice(threadIdx.x);

// 3. åˆ†åŒºè¾“å…¥è¾“å‡º
Tensor tCrA = thr_mma.partition_A(sA);
Tensor tCrB = thr_mma.partition_B(sB);
Tensor tCrC = thr_mma.partition_C(acc);

// 4. æ‰§è¡ŒGEMM
cute::gemm(tiled_mma, tCrA, tCrB, tCrC);
```

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [cute MMAæ–‡æ¡£](https://github.com/NVIDIA/cutlass/blob/main/media/docs/cute/0t_mma_atom.md)
- [Tensor Coreç¼–ç¨‹æŒ‡å—](https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#wmma)
- FlashAttentionæºç ï¼š`hopper/utils.h` ä¸­çš„ `gemm` å‡½æ•°



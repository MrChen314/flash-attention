# local_tileå±€éƒ¨åˆ†å—

> cuteå¯¹Tensoråˆ†å—è§†å›¾çš„æ ¸å¿ƒæŠ½è±¡

---

## 1. ä»€ä¹ˆæ˜¯local_tile

### 1.1 èƒŒæ™¯ï¼šåˆ†å—è®¡ç®—çš„éœ€æ±‚

FlashAttentionçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†å¤§çŸ©é˜µåˆ†å—å¤„ç†ï¼Œæ¯æ¬¡åªå¤„ç†ä¸€å°å—æ•°æ®ã€‚è¿™éœ€è¦ä¸€ç§æœºåˆ¶æ¥ä»å¤§Tensorä¸­è·å–å±€éƒ¨è§†å›¾ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆ†å—è®¡ç®—çš„éœ€æ±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   å…¨å±€QçŸ©é˜µ [seqlen Ã— headdim]                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ block 0 â”‚ block 1 â”‚ block 2 â”‚ ... â”‚     â”‚                   â”‚
â”‚   â”‚ 128Ã—64  â”‚ 128Ã—64  â”‚ 128Ã—64  â”‚     â”‚     â”‚                   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚     â”‚                   â”‚
â”‚   â”‚         â”‚         â”‚         â”‚     â”‚     â”‚                   â”‚
â”‚   â”‚   æ¯æ¬¡å¤„ç†ä¸€ä¸ªblock                  â”‚     â”‚                   â”‚
â”‚   â”‚   éœ€è¦è·å–è¯¥blockçš„è§†å›¾              â”‚     â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                  â”‚
â”‚   local_tileçš„ä½œç”¨ï¼š                                             â”‚
â”‚   ä»å¤§Tensorä¸­æå–æŒ‡å®šä½ç½®çš„åˆ†å—è§†å›¾                            â”‚
â”‚   ä¸æ‹·è´æ•°æ®ï¼Œåªæ˜¯åˆ›å»ºä¸€ä¸ªæŒ‡å‘è¯¥åŒºåŸŸçš„Tensor                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 local_tileå®šä¹‰

**local_tile**æ˜¯cuteä¸­ç”¨äºè·å–Tensorå±€éƒ¨åˆ†å—è§†å›¾çš„å‡½æ•°ï¼š

```cpp
// å‡½æ•°ç­¾å
template<class Tensor, class TileShape, class TileCoord>
auto local_tile(Tensor& tensor, TileShape tile_shape, TileCoord tile_coord);

// å‚æ•°è¯´æ˜
// tensor:     æºTensor
// tile_shape: åˆ†å—çš„å½¢çŠ¶ï¼Œå¦‚ Shape<_128, _64>
// tile_coord: åˆ†å—çš„åæ ‡ï¼Œå¦‚ make_coord(m_block, _0{})
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    local_tile è¯­ä¹‰                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Tensor mQ (2048, 64)                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚  è¡Œ0-127    â† local_tile(mQ, (128,64), (0, 0))          â”‚   â”‚
â”‚   â”‚  è¡Œ128-255  â† local_tile(mQ, (128,64), (1, 0))          â”‚   â”‚
â”‚   â”‚  è¡Œ256-383  â† local_tile(mQ, (128,64), (2, 0))          â”‚   â”‚
â”‚   â”‚  ...                                                     â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   è¿”å›å€¼: Tensorè§†å›¾ (128, 64)                                  â”‚
â”‚   æŒ‡å‘åŸTensorä¸­å¯¹åº”ä½ç½®çš„æ•°æ®                                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. local_tileå‚æ•°è¯¦è§£

### 2.1 tile_shapeï¼ˆåˆ†å—å½¢çŠ¶ï¼‰

tile_shapeå®šä¹‰äº†æ¯ä¸ªåˆ†å—çš„å¤§å°ï¼š

```cpp
// ä½¿ç”¨ç¼–è¯‘æœŸå¸¸é‡å®šä¹‰tileå½¢çŠ¶
using TileShape = Shape<Int<128>, Int<64>>;  // 128è¡ŒÃ—64åˆ—

// æˆ–è€…ä½¿ç”¨_Nè¯­æ³•
auto tile_shape = make_shape(_128{}, _64{});

// ä¹Ÿå¯ä»¥ä½¿ç”¨è¿è¡Œæ—¶å€¼ï¼ˆè¾ƒå°‘ç”¨ï¼‰
auto tile_shape = make_shape(128, 64);
```

### 2.2 tile_coordï¼ˆåˆ†å—åæ ‡ï¼‰

tile_coordæŒ‡å®šè¦è·å–çš„æ˜¯ç¬¬å‡ ä¸ªåˆ†å—ï¼š

```cpp
// è·å–ç¬¬m_blockä¸ªè¡Œå—ï¼Œç¬¬0ä¸ªåˆ—å—
auto coord = make_coord(m_block, _0{});

// ä½¿ç”¨_è¡¨ç¤ºè¯¥ç»´åº¦ä¿ç•™æ‰€æœ‰åˆ†å—
auto coord = make_coord(_, _0{});  // è¿”å›æ‰€æœ‰è¡Œå—

// å¤šä¸ªç»´åº¦ä½¿ç”¨_
auto coord = make_coord(_, _, bidb);  // batchç»´åº¦å›ºå®š
```

### 2.3 è¿”å›å€¼å½¢çŠ¶

```cpp
// åŸTensor: (M, N)
// tile_shape: (TileM, TileN)
// tile_coord: (m, n)
// è¿”å›: (TileM, TileN)  - å•ä¸ªåˆ†å—

// tile_coord: (_, n)
// è¿”å›: (TileM, TileN, num_m_tiles)  - æ‰€æœ‰è¡Œå—

// tile_coord: (m, _)
// è¿”å›: (TileM, TileN, num_n_tiles)  - æ‰€æœ‰åˆ—å—

// tile_coord: (_, _)
// è¿”å›: (TileM, TileN, num_m_tiles, num_n_tiles)  - æ‰€æœ‰å—
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    tile_coord çš„ä¸åŒç”¨æ³•                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Tensor (2048, 64), TileShape (128, 64)                        â”‚
â”‚                                                                  â”‚
â”‚   1. make_coord(3, 0)                                           â”‚
â”‚      è¿”å›: (128, 64)  ç¬¬3ä¸ªè¡Œå—                                 â”‚
â”‚                                                                  â”‚
â”‚   2. make_coord(_, 0)                                           â”‚
â”‚      è¿”å›: (128, 64, 16)  æ‰€æœ‰16ä¸ªè¡Œå—                          â”‚
â”‚                                                                  â”‚
â”‚   3. make_coord(3, _)                                           â”‚
â”‚      è¿”å›: (128, 64, 1)  ç¬¬3è¡Œå—çš„æ‰€æœ‰åˆ—å—ï¼ˆåªæœ‰1ä¸ªï¼‰           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. åœ¨FlashAttentionä¸­çš„åº”ç”¨

### 3.1 åŠ è½½Qçš„åˆ†å—

```cpp
// æ¥è‡ª hopper/mainloop_fwd_sm80.hpp

// åˆ›å»ºå…¨å±€QçŸ©é˜µçš„Tensor
Tensor mQ = make_tensor(
    make_gmem_ptr(params.ptr_Q + seqlen_info.offset_q * get<0>(params.stride_Q)), 
    params.shape_Q_packed, 
    params.stride_Q_packed
)(_, _, bidh, !is_varlen_q ? bidb : 0);

// ä½¿ç”¨local_tileè·å–ç¬¬m_blockä¸ªQå—
// select<0, 2>(TileShape_MNK{}) é€‰æ‹©Må’ŒKç»´åº¦çš„tileå¤§å°
Tensor gQ = local_tile(mQ, select<0, 2>(TileShape_MNK{}), make_coord(m_block, _0{}));  // (M, K)

// gQç°åœ¨æ˜¯ä¸€ä¸ª (kBlockM, headdim) çš„è§†å›¾
// æŒ‡å‘QçŸ©é˜µä¸­ç¬¬m_blockä¸ªåˆ†å—
```

### 3.2 éå†K/Vçš„åˆ†å—

```cpp
// KçŸ©é˜µéœ€è¦éå†æ‰€æœ‰Nå—
Tensor mK = make_tensor(
    make_gmem_ptr(params.ptr_K + ...), 
    params.shape_K, 
    params.stride_K
)(_, _, bidh_kv, !is_varlen_k ? bidb_kv : 0);

// ä½¿ç”¨_è·å–æ‰€æœ‰Nå—çš„è§†å›¾
Tensor gK = local_tile(mK, select<1, 2>(TileShape_MNK{}), make_coord(_, _0{}));  // (N, K, _)

// gKå½¢çŠ¶: (kBlockN, headdim, num_n_blocks)
// å¯ä»¥é€šè¿‡ gK(_, _, n_block) è®¿é—®ç¬¬n_blockä¸ªKå—
```

### 3.3 åˆ†å—éå†å¾ªç¯

```cpp
// FlashAttentionçš„ä¸»å¾ªç¯
int num_n_blocks = cute::ceil_div(seqlen_k, kBlockN);

for (int n_block = n_block_min; n_block < n_block_max; ++n_block) {
    // åŠ è½½ç¬¬n_blockä¸ªKå—
    // gK(_, _, n_block) æ˜¯ local_tile è¿”å›çš„è§†å›¾çš„åˆ‡ç‰‡
    Tensor tKgK_cur = tKgK(_, _, _, n_block);
    
    // æ‹·è´åˆ°å…±äº«å†…å­˜
    cute::copy(gmem_tiled_copy_QKV, tKgK_cur, tKsK);
    
    // ç±»ä¼¼åœ°å¤„ç†V
    Tensor tVgV_cur = tVgV(_, _, _, n_block);
    cute::copy(gmem_tiled_copy_QKV, tVgV_cur, tVsV);
    
    // ... MMAè®¡ç®— ...
}
```

### 3.4 å›¾è§£FlashAttentionçš„åˆ†å—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                FlashAttention åˆ†å—è®¡ç®—                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   QçŸ©é˜µ [seqlen_q Ã— d]          KçŸ©é˜µ [seqlen_k Ã— d]            â”‚
â”‚   â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”             â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”               â”‚
â”‚   â”‚Q0 â”‚   â”‚   â”‚   â”‚             â”‚K0 â”‚K1 â”‚K2 â”‚K3 â”‚               â”‚
â”‚   â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤             â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜               â”‚
â”‚   â”‚Q1 â”‚   â”‚   â”‚   â”‚                                              â”‚
â”‚   â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤             æ¯ä¸ªçº¿ç¨‹å—å¤„ç†:                 â”‚
â”‚   â”‚Q2 â”‚   â”‚   â”‚   â”‚             - ä¸€ä¸ªQå— (å›ºå®š)                â”‚
â”‚   â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤             - éå†æ‰€æœ‰K/Vå—                 â”‚
â”‚   â”‚Q3 â”‚   â”‚   â”‚   â”‚                                              â”‚
â”‚   â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜                                              â”‚
â”‚                                                                  â”‚
â”‚   Thread Block 0:                                                â”‚
â”‚   gQ = local_tile(mQ, (M,K), (0, 0))  â†’ Q0å—                    â”‚
â”‚   gK = local_tile(mK, (N,K), (_, 0))  â†’ æ‰€æœ‰Kå—                 â”‚
â”‚   for n in 0..4: è®¡ç®— Q0 @ K[n]^T                               â”‚
â”‚                                                                  â”‚
â”‚   Thread Block 1:                                                â”‚
â”‚   gQ = local_tile(mQ, (M,K), (1, 0))  â†’ Q1å—                    â”‚
â”‚   gK = local_tile(mK, (N,K), (_, 0))  â†’ æ‰€æœ‰Kå—                 â”‚
â”‚   for n in 0..4: è®¡ç®— Q1 @ K[n]^T                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. selectè¾…åŠ©å‡½æ•°

### 4.1 selectçš„ä½œç”¨

`select`ç”¨äºä»å¤šç»´TileShapeä¸­é€‰æ‹©ç‰¹å®šç»´åº¦ï¼š

```cpp
// TileShape_MNK = Shape<Int<128>, Int<64>, Int<64>>
//                       ^M        ^N       ^K

// select<0, 2> é€‰æ‹©ç¬¬0å’Œç¬¬2ç»´åº¦
select<0, 2>(TileShape_MNK{})  // è¿”å› Shape<Int<128>, Int<64>>
//                                          ^M          ^K

// ç”¨äºQ: éœ€è¦Må’ŒKç»´åº¦
Tensor gQ = local_tile(mQ, select<0, 2>(TileShape_MNK{}), ...);  // (M, K)

// select<1, 2> é€‰æ‹©ç¬¬1å’Œç¬¬2ç»´åº¦
select<1, 2>(TileShape_MNK{})  // è¿”å› Shape<Int<64>, Int<64>>
//                                          ^N         ^K

// ç”¨äºK: éœ€è¦Nå’ŒKç»´åº¦
Tensor gK = local_tile(mK, select<1, 2>(TileShape_MNK{}), ...);  // (N, K)
```

### 4.2 ä¸ºä»€ä¹ˆéœ€è¦select

```
FlashAttentionä¸­çš„ç»´åº¦:
- M: Qçš„åºåˆ—ç»´åº¦ (åˆ†å—å¤§å° kBlockM = 128)
- N: K/Vçš„åºåˆ—ç»´åº¦ (åˆ†å—å¤§å° kBlockN = 64)
- K: å¤´ç»´åº¦ (headdim = 64/128)

ä¸åŒçŸ©é˜µéœ€è¦ä¸åŒçš„ç»´åº¦ç»„åˆ:
- Q: (seqlen_q, headdim) â†’ ç”¨ (M, K) = select<0, 2>
- K: (seqlen_k, headdim) â†’ ç”¨ (N, K) = select<1, 2>
- V: (seqlen_k, headdim) â†’ ç”¨ (N, K) = select<1, 2>
- O: (seqlen_q, headdim) â†’ ç”¨ (M, K) = select<0, 2>

selectè®©ä»£ç æ›´æ¸…æ™°ï¼Œé¿å…é‡å¤å®šä¹‰TileShape
```

---

## 5. domain_offset

### 5.1 å¤„ç†å˜é•¿åºåˆ—

åœ¨varlenï¼ˆå¯å˜é•¿åº¦ï¼‰åœºæ™¯ä¸­ï¼Œéœ€è¦åç§»åˆ°æ­£ç¡®çš„èµ·å§‹ä½ç½®ï¼š

```cpp
// domain_offsetç”¨äºåç§»Tensorçš„èµ·å§‹ä½ç½®
Tensor mQ_offset = domain_offset(make_coord(seqlen_info.offset_q, _0{}), mQ);

// ç„¶åå†ä½¿ç”¨local_tile
Tensor gQ = local_tile(mQ_offset, tile_shape, tile_coord);
```

### 5.2 å®Œæ•´çš„varlenå¤„ç†

```cpp
// æ¥è‡ª hopper/mainloop_fwd_sm90_tma_gmma_ws.hpp

// è·å–TMA tensor
Tensor mQ = params.tma_load_Q.get_tma_tensor(params.shape_Q)(_, _, bidh, !is_varlen_q ? bidb : 0);

// ä½¿ç”¨domain_offsetåç§»åˆ°æ­£ç¡®ä½ç½®ï¼Œç„¶ålocal_tile
Tensor gQ = local_tile(
    domain_offset(make_coord(seqlen_info.offset_q, _0{}), mQ), 
    select<0, 2>(TileShape_MNK{}), 
    make_coord(m_block, _0{})
);  // (M, K)
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Varlen å¤„ç†                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   è¿ç»­å­˜å‚¨çš„å¤šä¸ªåºåˆ—:                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚  seq 0   â”‚  seq 1   â”‚  seq 2   â”‚  seq 3   â”‚                 â”‚
â”‚   â”‚  len=512 â”‚  len=256 â”‚  len=384 â”‚  len=128 â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚   offset:  0      512      768       1152                        â”‚
â”‚                                                                  â”‚
â”‚   cu_seqlens = [0, 512, 768, 1152, 1280]                        â”‚
â”‚                                                                  â”‚
â”‚   å¤„ç†seq 2:                                                     â”‚
â”‚   offset_q = cu_seqlens[2] = 768                                â”‚
â”‚   domain_offset(make_coord(768, _0{}), mQ)                      â”‚
â”‚   â†’ ä»ä½ç½®768å¼€å§‹çš„è§†å›¾                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ä¸TiledCopyé…åˆ

### 6.1 åˆ†å— â†’ åˆ†åŒº â†’ æ‹·è´

local_tileè·å–åˆ†å—åï¼Œé€šå¸¸é…åˆTiledCopyè¿›è¡Œæ•°æ®ä¼ è¾“ï¼š

```cpp
// 1. ä½¿ç”¨local_tileè·å–åˆ†å—è§†å›¾
Tensor gK = local_tile(mK, select<1, 2>(TileShape_MNK{}), make_coord(_, _0{}));

// 2. ä½¿ç”¨TiledCopyåˆ†åŒº
auto gmem_thr_copy = gmem_tiled_copy.get_thread_slice(threadIdx.x);
Tensor tKgK = gmem_thr_copy.partition_S(gK);  // åˆ†åŒºæº

// 3. åœ¨å¾ªç¯ä¸­æ‹·è´æ¯ä¸ªå—
for (int n_block = 0; n_block < num_blocks; ++n_block) {
    cute::copy(gmem_tiled_copy, tKgK(_, _, _, n_block), tKsK);
    cute::cp_async_fence();
    // ...
}
```

### 6.2 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    local_tile + TiledCopy æ•°æ®æµ                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   mK (å…¨å±€KçŸ©é˜µ)                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚   â”‚ K0 â”‚ K1 â”‚ K2 â”‚ K3 â”‚ K4 â”‚ ... â”‚      â”‚                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â”‚                                            â”‚
â”‚                     â†“ local_tile(_, (N,K), (_, 0))              â”‚
â”‚                                                                  â”‚
â”‚   gK (åˆ†å—è§†å›¾)                                                  â”‚
â”‚   å½¢çŠ¶: (kBlockN, headdim, num_blocks)                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚ gK(:,:,0) â”‚ gK(:,:,1) â”‚ gK(:,:,2) â”‚...â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                     â”‚                                            â”‚
â”‚                     â†“ partition_S(gK)                           â”‚
â”‚                                                                  â”‚
â”‚   tKgK (çº¿ç¨‹åˆ†åŒº)                                                â”‚
â”‚   å½¢çŠ¶: (CPY, CPY_N, CPY_K, num_blocks)                         â”‚
â”‚   æ¯ä¸ªçº¿ç¨‹è·å¾—è‡ªå·±è´Ÿè´£çš„æ•°æ®è§†å›¾                                 â”‚
â”‚                     â”‚                                            â”‚
â”‚                     â†“ copy(_, tKgK(:,:,:,n), tKsK)              â”‚
â”‚                                                                  â”‚
â”‚   sK (å…±äº«å†…å­˜)                                                  â”‚
â”‚   å½¢çŠ¶: (kBlockN, headdim)                                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. å¸¸è§æ¨¡å¼

### 7.1 å›ºå®šå— vs éå†å—

```cpp
// æ¨¡å¼1: å›ºå®šå—ï¼ˆQé€šå¸¸åªå¤„ç†ä¸€ä¸ªå—ï¼‰
Tensor gQ = local_tile(mQ, tile_shape, make_coord(m_block, _0{}));  // (M, K)

// æ¨¡å¼2: éå†å—ï¼ˆK/Véœ€è¦éå†æ‰€æœ‰å—ï¼‰
Tensor gK = local_tile(mK, tile_shape, make_coord(_, _0{}));  // (N, K, num_blocks)

// åœ¨å¾ªç¯ä¸­è®¿é—®æ¯ä¸ªå—
for (int n = 0; n < size<2>(gK); ++n) {
    Tensor gK_n = gK(_, _, n);  // ç¬¬nä¸ªå—
}
```

### 7.2 å¤šç»´åˆ†å—

```cpp
// 3D Tensorçš„åˆ†å—
Tensor mA = make_tensor(ptr, make_shape(M, N, K), stride);
Tensor gA = local_tile(mA, 
    make_shape(_64{}, _32{}, _16{}),   // æ¯ä¸ªç»´åº¦çš„å—å¤§å°
    make_coord(m, n, k)                 // å—åæ ‡
);
```

### 7.3 ç»“åˆceil_divè®¡ç®—å—æ•°

```cpp
// è®¡ç®—éœ€è¦å¤šå°‘å—
int num_m_blocks = cute::ceil_div(seqlen_q, kBlockM);
int num_n_blocks = cute::ceil_div(seqlen_k, kBlockN);

// éå†æ‰€æœ‰å—
for (int m_block = 0; m_block < num_m_blocks; ++m_block) {
    Tensor gQ = local_tile(mQ, tile_shape, make_coord(m_block, _0{}));
    // ...
}
```

---

## 8. è¾¹ç•Œå¤„ç†

### 8.1 ä¸å®Œæ•´çš„æœ€åä¸€å—

å½“åºåˆ—é•¿åº¦ä¸æ˜¯å—å¤§å°çš„å€æ•°æ—¶ï¼Œæœ€åä¸€å—ä¼šä¸å®Œæ•´ï¼š

```cpp
// seqlen_q = 2000, kBlockM = 128
// æœ€åä¸€å—åªæœ‰ 2000 - 15*128 = 80 è¡Œ

// local_tileä»ç„¶è¿”å›å®Œæ•´çš„tileå½¢çŠ¶
// ä½†éœ€è¦ç”¨predicateå¤„ç†è¶Šç•Œ
Tensor gQ = local_tile(mQ, make_shape(_128{}, _64{}), make_coord(15, _0{}));
// gQå½¢çŠ¶ä»æ˜¯(128, 64)ï¼Œä½†åªæœ‰å‰80è¡Œæœ‰æ•ˆ
```

### 8.2 ä½¿ç”¨predicate

```cpp
// åˆ›å»ºidentity tensorç”¨äºåˆ¤æ–­è¾¹ç•Œ
Tensor cQ = make_identity_tensor(make_shape(seqlen_q, headdim));
Tensor tQcQ = gmem_thr_copy.partition_S(cQ);

// æ£€æŸ¥è¾¹ç•Œ
int actual_seqlen = seqlen_info.seqlen_q - m_block * kBlockM;
#pragma unroll
for (int m = 0; m < size<1>(tQgQ); ++m) {
    if (get<0>(tQcQ(0, m, 0)) < actual_seqlen) {
        cute::copy(gmem_tiled_copy, tQgQ(_, m, _), tQsQ(_, m, _));
    } else {
        cute::clear(tQsQ(_, m, _));  // è¶Šç•Œéƒ¨åˆ†æ¸…é›¶
    }
}
```

---

## 9. å…³é”®æœ¯è¯­

| æœ¯è¯­ | è‹±æ–‡ | å«ä¹‰ |
|------|------|------|
| local_tile | - | è·å–Tensorçš„å±€éƒ¨åˆ†å—è§†å›¾ |
| tile_shape | - | åˆ†å—çš„å½¢çŠ¶ |
| tile_coord | - | åˆ†å—çš„åæ ‡ |
| _ (ä¸‹åˆ’çº¿) | - | è¡¨ç¤ºä¿ç•™è¯¥ç»´åº¦æ‰€æœ‰åˆ†å— |
| select | - | ä»å¤šç»´Shapeä¸­é€‰æ‹©ç‰¹å®šç»´åº¦ |
| domain_offset | - | åç§»Tensorçš„èµ·å§‹ä½ç½® |
| ceil_div | - | å‘ä¸Šå–æ•´é™¤æ³• |

---

## 10. æ€»ç»“

### 10.1 local_tileçš„æ ¸å¿ƒä»·å€¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    local_tile æ ¸å¿ƒä»·å€¼                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. é›¶æ‹·è´åˆ†å—                                                   â”‚
â”‚     â””â”€â”€ åˆ›å»ºè§†å›¾ï¼Œä¸ç§»åŠ¨æ•°æ®                                    â”‚
â”‚                                                                  â”‚
â”‚  2. çµæ´»çš„åæ ‡ç³»ç»Ÿ                                               â”‚
â”‚     â””â”€â”€ æ”¯æŒå›ºå®šåæ ‡å’Œé€šé…ç¬¦                                    â”‚
â”‚                                                                  â”‚
â”‚  3. ä¸TiledCopyæ— ç¼é…åˆ                                          â”‚
â”‚     â””â”€â”€ partitionåç›´æ¥ç”¨äºæ•°æ®ä¼ è¾“                             â”‚
â”‚                                                                  â”‚
â”‚  4. ç¼–è¯‘æœŸä¼˜åŒ–                                                   â”‚
â”‚     â””â”€â”€ ä½¿ç”¨Int<N>å¯ä»¥è®©ç¼–è¯‘å™¨ä¼˜åŒ–                              â”‚
â”‚                                                                  â”‚
â”‚  5. ç»Ÿä¸€çš„åˆ†å—æŠ½è±¡                                               â”‚
â”‚     â””â”€â”€ Q/K/V/Oéƒ½ç”¨ç›¸åŒæ–¹å¼å¤„ç†                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 å…¸å‹ä½¿ç”¨æ¨¡å¼

```cpp
// FlashAttentionä¸­çš„å…¸å‹æ¨¡å¼

// 1. å®šä¹‰TileShape
using TileShape_MNK = Shape<Int<128>, Int<64>, Int<64>>;  // M, N, K

// 2. åˆ›å»ºå…¨å±€Tensor
Tensor mQ = make_tensor(make_gmem_ptr(ptr_Q), shape_Q, stride_Q);
Tensor mK = make_tensor(make_gmem_ptr(ptr_K), shape_K, stride_K);

// 3. è·å–åˆ†å—è§†å›¾
Tensor gQ = local_tile(mQ, select<0, 2>(TileShape_MNK{}), make_coord(m_block, _0{}));  // å›ºå®šQå—
Tensor gK = local_tile(mK, select<1, 2>(TileShape_MNK{}), make_coord(_, _0{}));        // æ‰€æœ‰Kå—

// 4. é…åˆTiledCopyä½¿ç”¨
auto thr_copy = gmem_tiled_copy.get_thread_slice(threadIdx.x);
Tensor tQgQ = thr_copy.partition_S(gQ);
Tensor tKgK = thr_copy.partition_S(gK);

// 5. å¾ªç¯å¤„ç†Kå—
for (int n = 0; n < size<2>(tKgK); ++n) {
    cute::copy(gmem_tiled_copy, tKgK(_, _, _, n), tKsK);
    // ... è®¡ç®— ...
}
```

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [cute Tensoræ–‡æ¡£](https://github.com/NVIDIA/cutlass/blob/main/media/docs/cute/03_tensor.md)
- [cute Layoutä»£æ•°](https://github.com/NVIDIA/cutlass/blob/main/media/docs/cute/02_layout_algebra.md)
- FlashAttentionæºç ï¼š`hopper/mainloop_fwd_sm80.hpp`



# Tensorå¼ é‡æŠ½è±¡

> cuteçš„æ•°æ®è¡¨ç¤ºæ ¸å¿ƒï¼šç†è§£Tensor = æŒ‡é’ˆ + Layout

---

## 1. ä»€ä¹ˆæ˜¯cute Tensor

### 1.1 å®šä¹‰

åœ¨cuteä¸­ï¼Œ**Tensor**æ˜¯æœ€åŸºæœ¬çš„æ•°æ®æŠ½è±¡ï¼Œå®ƒå°†ä¸€ä¸ª**å†…å­˜æŒ‡é’ˆ**ä¸ä¸€ä¸ª**Layout**ç»„åˆåœ¨ä¸€èµ·ï¼Œæä¾›å¤šç»´æ•°ç»„çš„è®¿é—®æ¥å£ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cute Tensor ç»“æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Tensor = Engine + Layout                                       â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚       Engine         â”‚    â”‚          Layout              â”‚  â”‚
â”‚   â”‚    (æ•°æ®å­˜å‚¨)         â”‚    â”‚       (ç´¢å¼•æ˜ å°„)              â”‚  â”‚
â”‚   â”‚                      â”‚    â”‚                              â”‚  â”‚
â”‚   â”‚   â€¢ æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆ    â”‚ +  â”‚   â€¢ Shape: å„ç»´åº¦å¤§å°        â”‚  â”‚
â”‚   â”‚   â€¢ å¯ä»¥æ˜¯gmem/smem  â”‚    â”‚   â€¢ Stride: å„ç»´åº¦æ­¥é•¿       â”‚  â”‚
â”‚   â”‚   â€¢ æˆ–å¯„å­˜å™¨æ•°ç»„      â”‚    â”‚   â€¢ å®šä¹‰é€»è¾‘â†’ç‰©ç†æ˜ å°„        â”‚  â”‚
â”‚   â”‚                      â”‚    â”‚                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚   ç»“æœï¼štensor(i, j, k) â†’ é€šè¿‡Layoutè®¡ç®—åç§» â†’ è®¿é—®Engineä¸­çš„æ•°æ® â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦TensoræŠ½è±¡

| ä¼ ç»ŸCUDAç¼–ç¨‹ | cute Tensor |
|--------------|-------------|
| æ‰‹åŠ¨è®¡ç®—çº¿æ€§åç§» `ptr[i*N + j]` | å¤šç»´ç´¢å¼• `tensor(i, j)` |
| å®¹æ˜“å‡ºé”™çš„ç´¢å¼•è®¡ç®— | ç¼–è¯‘æœŸæ£€æŸ¥çš„å¸ƒå±€ |
| ä¸åŒå†…å­˜éœ€è¦ä¸åŒå¤„ç† | ç»Ÿä¸€çš„æ¥å£ |
| éš¾ä»¥è¡¨è¾¾å¤æ‚å¸ƒå±€ | å£°æ˜å¼çš„Layout |

---

## 2. Tensorçš„åˆ›å»º

### 2.1 make_tensorå‡½æ•°

cuteæä¾›`make_tensor`å‡½æ•°æ¥åˆ›å»ºTensorï¼š

```cpp
#include <cute/tensor.hpp>
using namespace cute;

// åŸºæœ¬å½¢å¼
Tensor tensor = make_tensor(pointer, layout);

// æˆ–è€…åˆ†å¼€æŒ‡å®šshapeå’Œstride
Tensor tensor = make_tensor(pointer, shape, stride);
```

### 2.2 æŒ‡é’ˆç±»å‹

cuteæ ¹æ®å†…å­˜ç±»å‹æä¾›ä¸åŒçš„æŒ‡é’ˆåŒ…è£…å™¨ï¼š

```cpp
// 1. å…¨å±€å†…å­˜ï¼ˆHBMï¼‰
float* raw_ptr = ...;  // åŸå§‹CUDAæŒ‡é’ˆ
auto gmem_ptr = make_gmem_ptr(raw_ptr);
Tensor gA = make_tensor(gmem_ptr, layout);

// 2. å…±äº«å†…å­˜ï¼ˆSMEMï¼‰
__shared__ float smem_buffer[1024];
auto smem_ptr = make_smem_ptr(smem_buffer);
Tensor sA = make_tensor(smem_ptr, layout);

// 3. å¯„å­˜å™¨ï¼ˆä¸éœ€è¦åŒ…è£…å™¨ï¼Œç›´æ¥ç”¨æ•°ç»„ï¼‰
float reg_buffer[32];
Tensor rA = make_tensor(reg_buffer, layout);
```

```
æŒ‡é’ˆç±»å‹å¯¹åº”çš„å†…å­˜å±‚æ¬¡:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GPUå†…å­˜å±‚æ¬¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   å¯„å­˜å™¨ (Registers)                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  â€¢ æœ€å¿«çš„å­˜å‚¨                                            â”‚   â”‚
â”‚   â”‚  â€¢ æ¯ä¸ªçº¿ç¨‹ç§æœ‰                                          â”‚   â”‚
â”‚   â”‚  â€¢ cute: ç›´æ¥ä½¿ç”¨æ•°ç»„æˆ–make_fragment_like               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†‘â†“                                  â”‚
â”‚   å…±äº«å†…å­˜ (SMEM)                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  â€¢ å¿«é€Ÿçš„ç‰‡ä¸Šå†…å­˜ (~20å‘¨æœŸå»¶è¿Ÿ)                          â”‚   â”‚
â”‚   â”‚  â€¢ çº¿ç¨‹å—å†…å…±äº«                                          â”‚   â”‚
â”‚   â”‚  â€¢ cute: make_smem_ptr()                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†‘â†“                                  â”‚
â”‚   å…¨å±€å†…å­˜ (HBM/GMEM)                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  â€¢ å¤§å®¹é‡ä½†æ…¢ (~400å‘¨æœŸå»¶è¿Ÿ)                             â”‚   â”‚
â”‚   â”‚  â€¢ æ‰€æœ‰çº¿ç¨‹å¯è®¿é—®                                        â”‚   â”‚
â”‚   â”‚  â€¢ cute: make_gmem_ptr()                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 åˆ›å»ºç¤ºä¾‹

```cpp
// ç¤ºä¾‹1ï¼šåˆ›å»ºä¸€ä¸ª 128Ã—64 çš„å…¨å±€å†…å­˜Tensorï¼ˆè¡Œä¼˜å…ˆï¼‰
half_t* q_ptr = params.q_ptr;
Tensor gQ = make_tensor(
    make_gmem_ptr(q_ptr),
    make_layout(
        make_shape(128, 64),    // Shape: (M, K)
        make_stride(64, 1)      // Stride: è¡Œä¼˜å…ˆ
    )
);

// ç¤ºä¾‹2ï¼šä½¿ç”¨é™æ€å¤§å°ï¼ˆç¼–è¯‘æœŸå¸¸é‡ï¼‰
Tensor gQ_static = make_tensor(
    make_gmem_ptr(q_ptr),
    make_layout(
        make_shape(Int<128>{}, Int<64>{}),  // ç¼–è¯‘æœŸShape
        make_stride(Int<64>{}, Int<1>{})    // ç¼–è¯‘æœŸStride
    )
);

// ç¤ºä¾‹3ï¼šåˆ›å»ºå…±äº«å†…å­˜Tensor
extern __shared__ char smem[];
half_t* smem_q = reinterpret_cast<half_t*>(smem);
Tensor sQ = make_tensor(
    make_smem_ptr(smem_q),
    make_layout(make_shape(Int<128>{}, Int<64>{}))
);
```

---

## 3. Tensorçš„è®¿é—®

### 3.1 å¤šç»´ç´¢å¼•

Tensoræ”¯æŒç›´æ¥ä½¿ç”¨å¤šç»´åæ ‡è®¿é—®å…ƒç´ ï¼š

```cpp
Tensor A = make_tensor(ptr, make_layout(make_shape(4, 3)));

// è¯»å–å…ƒç´ 
float val = A(2, 1);  // è®¿é—®ç¬¬2è¡Œç¬¬1åˆ—

// å†™å…¥å…ƒç´ 
A(0, 0) = 1.0f;

// ä¹Ÿå¯ä»¥ç”¨çº¿æ€§ç´¢å¼•
float val2 = A(5);  // ç¬¬5ä¸ªå…ƒç´ ï¼ˆæŒ‰Layoutå±•å¼€ï¼‰
```

### 3.2 ç´¢å¼•è®¡ç®—

cuteä¼šæ ¹æ®Layoutè‡ªåŠ¨è®¡ç®—å†…å­˜åç§»ï¼š

```
é€»è¾‘åæ ‡ (i, j) â†’ Layoutæ˜ å°„ â†’ ç‰©ç†åç§» offset

è®¡ç®—å…¬å¼ï¼šoffset = i * stride_0 + j * stride_1

ç¤ºä¾‹ï¼ˆ4Ã—3çŸ©é˜µï¼Œè¡Œä¼˜å…ˆï¼‰ï¼š
Layout: Shape=(4,3), Stride=(3,1)

é€»è¾‘è§†å›¾:              åç§»è®¡ç®—:
[0,0] [0,1] [0,2]     (0,0) â†’ 0*3 + 0*1 = 0
[1,0] [1,1] [1,2]     (1,0) â†’ 1*3 + 0*1 = 3
[2,0] [2,1] [2,2]     (2,1) â†’ 2*3 + 1*1 = 7
[3,0] [3,1] [3,2]     (3,2) â†’ 3*3 + 2*1 = 11

çº¿æ€§å†…å­˜: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
```

---

## 4. Tensorçš„å˜æ¢æ“ä½œ

### 4.1 local_tile - è·å–å±€éƒ¨åˆ†å—

ä»å¤§Tensorä¸­è·å–ä¸€ä¸ªå°çš„è§†å›¾ï¼š

```cpp
// åŸå§‹Tensor: [2048, 64]
Tensor gQ = make_tensor(ptr, make_layout(make_shape(2048, 64)));

// è·å–ç¬¬ä¸€ä¸ª 128Ã—64 çš„tile
Tensor tile = local_tile(
    gQ,
    make_shape(Int<128>{}, Int<64>{}),  // tileå¤§å°
    make_coord(0, 0)                     // tileåæ ‡
);
// tileå½¢çŠ¶: [128, 64]

// è·å–ç¬¬äºŒä¸ªtileï¼ˆè¡Œæ–¹å‘åç§»128ï¼‰
Tensor tile2 = local_tile(gQ, make_shape(128, 64), make_coord(1, 0));
```

```
local_tile ç¤ºæ„å›¾:

åŸå§‹Tensor gQ [2048 Ã— 64]:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                â”‚
â”‚  tile(0,0)     tile(0,1) ...                   â”‚
â”‚  [128Ã—64]      [128Ã—64]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  tile(1,0)     tile(1,1) ...                   â”‚
â”‚  [128Ã—64]      [128Ã—64]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ...                                           â”‚
â”‚                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  tile(15,0)    tile(15,1) ...                  â”‚
â”‚  [128Ã—64]      [128Ã—64]                        â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

local_tile(gQ, (128,64), (1,0)) è¿”å›ç¬¬1è¡Œç¬¬0åˆ—çš„tileè§†å›¾
```

### 4.2 partition - çº¿ç¨‹åˆ†åŒº

å°†Tensoråˆ†é…ç»™å¤šä¸ªçº¿ç¨‹ï¼š

```cpp
// TiledCopyå®šä¹‰äº†å¦‚ä½•åˆ†é…
TiledCopy tiled_copy = ...;
auto thr_copy = tiled_copy.get_thread_slice(threadIdx.x);

// åˆ†åŒºæºTensorå’Œç›®æ ‡Tensor
Tensor tSrc = thr_copy.partition_S(gQ);  // å½“å‰çº¿ç¨‹è´Ÿè´£çš„æºæ•°æ®
Tensor tDst = thr_copy.partition_D(sQ);  // å½“å‰çº¿ç¨‹è´Ÿè´£çš„ç›®æ ‡ä½ç½®
```

### 4.3 slice - åˆ‡ç‰‡

æ²¿æŸä¸ªç»´åº¦å–åˆ‡ç‰‡ï¼š

```cpp
Tensor A = make_tensor(ptr, make_layout(make_shape(4, 3, 2)));

// å–ç¬¬ä¸€ä¸ªç»´åº¦çš„ç¬¬2ä¸ªåˆ‡ç‰‡
Tensor slice = A(2, _, _);  // å½¢çŠ¶: [3, 2]

// ä½¿ç”¨cute::slice
Tensor slice2 = cute::slice(A, make_coord(2, _, _));
```

---

## 5. Fragmentï¼ˆå¯„å­˜å™¨Tensorï¼‰

### 5.1 ä»€ä¹ˆæ˜¯Fragment

Fragmentæ˜¯å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­çš„Tensorï¼Œç”¨äºTiledMMAçš„è¾“å…¥è¾“å‡ºï¼š

```cpp
// åˆ›å»ºä¸æŸä¸ªLayoutåŒ¹é…çš„Fragment
auto tiled_mma = make_tiled_mma(...);
auto thr_mma = tiled_mma.get_thread_slice(threadIdx.x);

// åˆ›å»ºç´¯åŠ å™¨Fragment
Tensor acc = make_fragment_like(thr_mma.partition_C(smem_C));

// æ¸…é›¶
clear(acc);

// æ‰§è¡ŒMMAï¼Œç»“æœå­˜å…¥acc
cute::gemm(tiled_mma, fragA, fragB, acc);
```

### 5.2 Fragment vs æ™®é€šTensor

| ç‰¹æ€§ | Fragment | æ™®é€šTensor |
|------|----------|------------|
| å­˜å‚¨ä½ç½® | å¯„å­˜å™¨ | HBM/SMEM |
| è®¿é—®é€Ÿåº¦ | æœ€å¿« | è¾ƒæ…¢ |
| æ¯çº¿ç¨‹å¯è§æ€§ | ä»…å½“å‰çº¿ç¨‹ | å¯å…±äº« |
| ä¸»è¦ç”¨é€” | MMAè¾“å…¥è¾“å‡ºã€ç´¯åŠ å™¨ | æ•°æ®å­˜å‚¨ |

---

## 6. åœ¨FlashAttentionä¸­çš„åº”ç”¨

### 6.1 Q/K/V Tensorå®šä¹‰

```cpp
// flash_fwd_kernel_sm80.h ä¸­çš„å…¸å‹æ¨¡å¼

// åˆ›å»ºå…¨å±€å†…å­˜ä¸­çš„QçŸ©é˜µTensor
Tensor mQ = make_tensor(
    make_gmem_ptr(reinterpret_cast<Element*>(params.q_ptr)),
    make_shape(params.seqlen_q, params.d),
    make_stride(params.q_row_stride, Int<1>{})
);

// è·å–å½“å‰blockå¤„ç†çš„Qåˆ†å—
Tensor gQ = local_tile(mQ, TileShape_MK{}, make_coord(m_block, 0));

// åˆ›å»ºå…±äº«å†…å­˜Tensor
extern __shared__ char smem_[];
Tensor sQ = make_tensor(
    make_smem_ptr(reinterpret_cast<Element*>(smem_)),
    SmemLayoutQ{}
);
```

### 6.2 æ•°æ®æµç¤ºä¾‹

```
FlashAttentionä¸­Tensorçš„æ•°æ®æµ:

1. å…¨å±€å†…å­˜ (HBM)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  mQ [seqlen Ã— headdim]                     â”‚
   â”‚  mK [seqlen Ã— headdim]                     â”‚
   â”‚  mV [seqlen Ã— headdim]                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ local_tile
                     â–¼
2. å…¨å±€å†…å­˜åˆ†å—è§†å›¾
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  gQ [kBlockM Ã— headdim]  â† å½“å‰blockè´Ÿè´£   â”‚
   â”‚  gK [kBlockN Ã— headdim]                    â”‚
   â”‚  gV [kBlockN Ã— headdim]                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ TiledCopy (cp_async)
                     â–¼
3. å…±äº«å†…å­˜ (SMEM)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  sQ [kBlockM Ã— headdim]                    â”‚
   â”‚  sK [kBlockN Ã— headdim]                    â”‚
   â”‚  sV [kBlockN Ã— headdim]                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ TiledCopy (S2R)
                     â–¼
4. å¯„å­˜å™¨ (Fragment)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  tQrQ [çº¿ç¨‹æœ¬åœ°çš„Qç‰‡æ®µ]                     â”‚
   â”‚  tKrK [çº¿ç¨‹æœ¬åœ°çš„Kç‰‡æ®µ]                     â”‚
   â”‚  acc  [ç´¯åŠ å™¨]                             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ TiledMMA (gemm)
                     â–¼
5. è®¡ç®—ç»“æœ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  S = QK^T (å­˜åœ¨accä¸­)                      â”‚
   â”‚  â†’ Softmax â†’ P                             â”‚
   â”‚  O = PV                                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. å…³é”®æœ¯è¯­

| æœ¯è¯­ | è‹±æ–‡ | å«ä¹‰ |
|------|------|------|
| Engine | - | Tensorä¸­å­˜å‚¨æ•°æ®çš„éƒ¨åˆ†ï¼ˆæŒ‡é’ˆæˆ–æ•°ç»„ï¼‰ |
| Layout | - | Tensorä¸­æè¿°ç´¢å¼•æ˜ å°„çš„éƒ¨åˆ† |
| gmem_ptr | Global Memory Pointer | æŒ‡å‘HBMçš„æŒ‡é’ˆåŒ…è£…å™¨ |
| smem_ptr | Shared Memory Pointer | æŒ‡å‘å…±äº«å†…å­˜çš„æŒ‡é’ˆåŒ…è£…å™¨ |
| Fragment | - | å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­çš„Tensor |
| local_tile | - | è·å–Tensorçš„å±€éƒ¨åˆ†å—è§†å›¾ |
| partition | - | å°†Tensoråˆ†é…ç»™çº¿ç¨‹ |

---

## 8. æ€»ç»“

### 8.1 Tensorçš„æ ¸å¿ƒä»·å€¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cute Tensor æ ¸å¿ƒä»·å€¼                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. ç»Ÿä¸€æ¥å£                                                     â”‚
â”‚     â””â”€â”€ æ— è®ºHBMã€SMEMè¿˜æ˜¯å¯„å­˜å™¨ï¼Œéƒ½ç”¨ç›¸åŒæ–¹å¼è®¿é—®                â”‚
â”‚                                                                  â”‚
â”‚  2. å¤šç»´ç´¢å¼•                                                     â”‚
â”‚     â””â”€â”€ tensor(i, j, k) è€Œä¸æ˜¯æ‰‹åŠ¨è®¡ç®— ptr[...]                 â”‚
â”‚                                                                  â”‚
â”‚  3. é›¶å¼€é”€æŠ½è±¡                                                   â”‚
â”‚     â””â”€â”€ Layoutåœ¨ç¼–è¯‘æœŸè§£æï¼Œè¿è¡Œæ—¶æ— é¢å¤–å¼€é”€                     â”‚
â”‚                                                                  â”‚
â”‚  4. å¯ç»„åˆæ€§                                                     â”‚
â”‚     â””â”€â”€ sliceã€local_tileã€partitionç­‰æ“ä½œå¯è‡ªç”±ç»„åˆ            â”‚
â”‚                                                                  â”‚
â”‚  5. ç±»å‹å®‰å…¨                                                     â”‚
â”‚     â””â”€â”€ ç¼–è¯‘æœŸæ£€æŸ¥Shape/Strideå…¼å®¹æ€§                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 å¸¸è§ä½¿ç”¨æ¨¡å¼

```cpp
// æ¨¡å¼1ï¼šåˆ›å»º â†’ åˆ†å— â†’ æ‹·è´ â†’ è®¡ç®—
Tensor mQ = make_tensor(make_gmem_ptr(ptr), shape, stride);  // åˆ›å»º
Tensor gQ = local_tile(mQ, tile_shape, coord);                // åˆ†å—
cute::copy(tiled_copy, tSgQ, tSsQ);                           // æ‹·è´
cute::gemm(tiled_mma, fragQ, fragK, acc);                     // è®¡ç®—

// æ¨¡å¼2ï¼šFragmentä½œä¸ºä¸­é—´å­˜å‚¨
Tensor acc = make_fragment_like(thr_mma.partition_C(sC));
clear(acc);
// ... MMAç´¯åŠ  ...
// ... å†™å›å…¨å±€å†…å­˜ ...
```

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [cuteå®˜æ–¹Tensoræ•™ç¨‹](https://github.com/NVIDIA/cutlass/blob/main/media/docs/cute/03_tensor.md)
- [CUTLASS cuteç¤ºä¾‹](https://github.com/NVIDIA/cutlass/tree/main/examples/cute)
- FlashAttentionæºç ï¼š`hopper/mainloop_fwd_sm80.hpp`



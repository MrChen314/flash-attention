# cuteå¼ é‡æŠ½è±¡å±‚

> CUTLASS 3.xçš„æ ¸å¿ƒåˆ›æ–°ï¼šç†è§£cuteçš„è®¾è®¡ç†å¿µ

---

## 1. ä»€ä¹ˆæ˜¯cute

### 1.1 å®šä¹‰

**cute**ï¼ˆCuTe, CUTLASS Templateï¼‰æ˜¯CUTLASS 3.xå¼•å…¥çš„ä¸€ä¸ªå¼ é‡æŠ½è±¡å±‚ï¼Œç”¨äºç®€åŒ–GPUä¸Šçš„é«˜æ€§èƒ½å¼ é‡æ“ä½œç¼–ç¨‹ã€‚å®ƒæä¾›äº†ä¸€å¥—ç»Ÿä¸€çš„æŠ½è±¡æ¥æè¿°ï¼š

- å¼ é‡çš„å½¢çŠ¶å’Œå†…å­˜å¸ƒå±€
- æ•°æ®åœ¨ä¸åŒå†…å­˜å±‚æ¬¡é—´çš„ç§»åŠ¨
- Tensor Coreæ“ä½œçš„å°è£…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cuteçš„å®šä½                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   ä¼ ç»ŸCUDAç¼–ç¨‹                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  â€¢ æ‰‹åŠ¨è®¡ç®—çº¿ç¨‹ç´¢å¼•                                      â”‚   â”‚
â”‚   â”‚  â€¢ æ‰‹åŠ¨ç®¡ç†å…±äº«å†…å­˜å¸ƒå±€                                  â”‚   â”‚
â”‚   â”‚  â€¢ æ‰‹åŠ¨è°ƒç”¨MMAæŒ‡ä»¤                                       â”‚   â”‚
â”‚   â”‚  â€¢ ä»£ç å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™                                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                   â”‚
â”‚   cuteæŠ½è±¡å±‚                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  â€¢ ç»Ÿä¸€çš„TensoræŠ½è±¡                                      â”‚   â”‚
â”‚   â”‚  â€¢ å£°æ˜å¼çš„Layoutæè¿°                                    â”‚   â”‚
â”‚   â”‚  â€¢ é«˜å±‚çš„TiledMMA/TiledCopy                             â”‚   â”‚
â”‚   â”‚  â€¢ ä»£ç ç®€æ´ï¼Œå¯ç»„åˆ                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   ç»“æœï¼šç”¨æ›´å°‘çš„ä»£ç å®ç°åŒç­‰æ€§èƒ½çš„kernel                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 cuteçš„è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æè¿° |
|------|------|
| **å¯ç»„åˆæ€§** | å°çš„æŠ½è±¡ç»„åˆæˆå¤æ‚æ“ä½œ |
| **è¡¨è¾¾åŠ›** | èƒ½è¡¨è¾¾å„ç§å†…å­˜å¸ƒå±€å’Œæ“ä½œæ¨¡å¼ |
| **é›¶å¼€é”€** | æŠ½è±¡ä¸å¼•å…¥è¿è¡Œæ—¶å¼€é”€ |
| **ç±»å‹å®‰å…¨** | ç¼–è¯‘æœŸæ£€æŸ¥å¸ƒå±€å…¼å®¹æ€§ |

---

## 2. cuteæ ¸å¿ƒæ¦‚å¿µ

### 2.1 æ¦‚å¿µæ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cuteæ ¸å¿ƒæ¦‚å¿µ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   1. Layoutï¼ˆå¸ƒå±€ï¼‰                                              â”‚
â”‚      â””â”€â”€ æè¿°æ•°æ®å¦‚ä½•å­˜å‚¨åœ¨å†…å­˜ä¸­                                â”‚
â”‚          â€¢ Shape: å½¢çŠ¶ï¼Œå¦‚ (M, N)                                â”‚
â”‚          â€¢ Stride: æ­¥é•¿ï¼Œå¦‚ (N, 1)                               â”‚
â”‚                                                                  â”‚
â”‚   2. Tensorï¼ˆå¼ é‡ï¼‰                                              â”‚
â”‚      â””â”€â”€ æ•°æ®æŒ‡é’ˆ + Layout                                       â”‚
â”‚          â€¢ å¯¹å†…å­˜çš„æŠ½è±¡è§†å›¾                                      â”‚
â”‚          â€¢ æ”¯æŒå¤šç»´ç´¢å¼•                                          â”‚
â”‚                                                                  â”‚
â”‚   3. TiledMMAï¼ˆåˆ†å—çŸ©é˜µä¹˜ï¼‰                                      â”‚
â”‚      â””â”€â”€ å°è£…Tensor Coreæ“ä½œ                                     â”‚
â”‚          â€¢ è‡ªåŠ¨å¤„ç†çº¿ç¨‹æ˜ å°„                                      â”‚
â”‚          â€¢ è‡ªåŠ¨å¤„ç†å¯„å­˜å™¨åˆ†é…                                    â”‚
â”‚                                                                  â”‚
â”‚   4. TiledCopyï¼ˆåˆ†å—æ‹·è´ï¼‰                                       â”‚
â”‚      â””â”€â”€ å°è£…é«˜æ•ˆå†…å­˜æ‹·è´                                        â”‚
â”‚          â€¢ æ”¯æŒå¼‚æ­¥æ‹·è´                                          â”‚
â”‚          â€¢ è‡ªåŠ¨å¤„ç†bank conflict                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Layoutè¯¦è§£

Layoutæ˜¯cuteä¸­æœ€åŸºç¡€çš„æ¦‚å¿µï¼Œå®ƒæè¿°äº†æ•°æ®åœ¨çº¿æ€§å†…å­˜ä¸­çš„æ’åˆ—æ–¹å¼ã€‚

```cpp
// Layout = (Shape, Stride)
// 
// Shape: æ¯ä¸ªç»´åº¦çš„å¤§å°
// Stride: æ¯ä¸ªç»´åº¦çš„æ­¥é•¿

// ä¾‹1: è¡Œä¼˜å…ˆçš„4x3çŸ©é˜µ
// Shape = (4, 3), Stride = (3, 1)
//
// é€»è¾‘è§†å›¾:          çº¿æ€§å†…å­˜:
// [0,0] [0,1] [0,2]  [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
// [1,0] [1,1] [1,2]     â†‘     â†‘     â†‘     â†‘
// [2,0] [2,1] [2,2]   row0  row1  row2  row3
// [3,0] [3,1] [3,2]
//
// è®¿é—®(i,j): offset = i * 3 + j * 1

// ä¾‹2: åˆ—ä¼˜å…ˆçš„4x3çŸ©é˜µ
// Shape = (4, 3), Stride = (1, 4)
//
// é€»è¾‘è§†å›¾:          çº¿æ€§å†…å­˜:
// [0,0] [0,1] [0,2]  [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
// [1,0] [1,1] [1,2]     â†‘        â†‘        â†‘
// [2,0] [2,1] [2,2]   col0     col1     col2
// [3,0] [3,1] [3,2]
//
// è®¿é—®(i,j): offset = i * 1 + j * 4
```

```cpp
// cuteä»£ç ç¤ºä¾‹
#include <cute/tensor.hpp>

using namespace cute;

// åˆ›å»ºè¡Œä¼˜å…ˆå¸ƒå±€
Layout row_major = make_layout(make_shape(4, 3), make_stride(3, 1));

// åˆ›å»ºåˆ—ä¼˜å…ˆå¸ƒå±€
Layout col_major = make_layout(make_shape(4, 3), make_stride(1, 4));

// ä½¿ç”¨ç¼–è¯‘æœŸå¸¸é‡
Layout static_layout = make_layout(make_shape(Int<4>{}, Int<3>{}), 
                                    make_stride(Int<3>{}, Int<1>{}));
```

### 2.3 Tensorè¯¦è§£

Tensoræ˜¯cuteä¸­è¡¨ç¤ºæ•°æ®çš„æ ¸å¿ƒæŠ½è±¡ï¼Œå®ƒå°†æŒ‡é’ˆä¸Layoutç»„åˆåœ¨ä¸€èµ·ã€‚

```cpp
// Tensor = Pointer + Layout
//
// æä¾›å¤šç»´è®¿é—®æ¥å£

// åˆ›å»ºå…¨å±€å†…å­˜Tensor
float* ptr = ...;  // æŒ‡å‘HBMçš„æŒ‡é’ˆ
Tensor gmem_tensor = make_tensor(make_gmem_ptr(ptr), 
                                  make_layout(make_shape(M, N), 
                                              make_stride(N, 1)));

// åˆ›å»ºå…±äº«å†…å­˜Tensor
__shared__ float smem[128];
Tensor smem_tensor = make_tensor(make_smem_ptr(smem),
                                  make_layout(make_shape(16, 8)));

// è®¿é—®å…ƒç´ 
gmem_tensor(i, j) = value;  // å†™å…¥
float x = smem_tensor(m, n);  // è¯»å–
```

```
Tensorç»“æ„ç¤ºæ„å›¾:

Tensor gmem_Q
â”œâ”€â”€ ptr: æŒ‡å‘QçŸ©é˜µåœ¨HBMä¸­çš„èµ·å§‹åœ°å€
â””â”€â”€ layout: 
    â”œâ”€â”€ shape: (seqlen, head_dim)
    â””â”€â”€ stride: (head_dim, 1)

å†…å­˜è§†å›¾:
HBM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ q[0,0] q[0,1] ... q[0,d-1]          â”‚  â† ç¬¬0è¡Œ
â”‚ q[1,0] q[1,1] ... q[1,d-1]          â”‚  â† ç¬¬1è¡Œ
â”‚ ...                                  â”‚
â”‚ q[N-1,0] q[N-1,1] ... q[N-1,d-1]    â”‚  â† ç¬¬N-1è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 TiledMMAè¯¦è§£

TiledMMAå°è£…äº†Tensor Coreçš„çŸ©é˜µä¹˜ç´¯åŠ æ“ä½œã€‚

```cpp
// TiledMMAçš„ç»„æˆ
//
// 1. MMA Atom: å•ä¸ªTensor CoreæŒ‡ä»¤ï¼ˆå¦‚16x8x16ï¼‰
// 2. Atom Layout: å¤šä¸ªMMA Atomå¦‚ä½•æ’åˆ—
// 3. Permutation: çº¿ç¨‹åˆ°æ•°æ®çš„æ˜ å°„

// åˆ›å»ºTiledMMA
using MmaAtom = MMA_Atom<SM80_16x8x16_F32F16F16F32_TN>;
using TiledMma = TiledMMA<
    MmaAtom,
    Layout<Shape<_2, _2, _1>>,  // 2x2ä¸ªAtom
    Tile<_32, _32, _16>         // æ¯ä¸ªtileçš„å¤§å°
>;
```

```
TiledMMAç¤ºæ„å›¾:

å•ä¸ªMMA Atom (SM80_16x8x16):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    A [16Ã—16]    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      (FP16)     â”‚  @  â”‚  B [16Ã—8]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   (FP16)    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    C [16Ã—8]     â”‚
â”‚     (FP32)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TiledMMA (2Ã—2 Atoms):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Atom[0,0]     â”‚   Atom[0,1]    â”‚
â”‚  [16Ã—16]@[16Ã—8]â”‚  [16Ã—16]@[16Ã—8]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Atom[1,0]     â”‚   Atom[1,1]    â”‚
â”‚  [16Ã—16]@[16Ã—8]â”‚  [16Ã—16]@[16Ã—8]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
        C [32Ã—16] (ç»„åˆè¾“å‡º)
```

### 2.5 TiledCopyè¯¦è§£

TiledCopyå°è£…äº†é«˜æ•ˆçš„å†…å­˜æ‹·è´æ“ä½œã€‚

```cpp
// TiledCopyç”¨äºä¸åŒå†…å­˜å±‚æ¬¡é—´çš„æ•°æ®ä¼ è¾“
//
// æ”¯æŒçš„æ‹·è´ç±»å‹:
// - å…¨å±€å†…å­˜ â†’ å…±äº«å†…å­˜ (G2S)
// - å…±äº«å†…å­˜ â†’ å¯„å­˜å™¨ (S2R)
// - å¯„å­˜å™¨ â†’ å…±äº«å†…å­˜ (R2S)
// - å…±äº«å†…å­˜ â†’ å…¨å±€å†…å­˜ (S2G)

// åˆ›å»ºå¼‚æ­¥æ‹·è´
using CopyAtom = Copy_Atom<SM80_CP_ASYNC_CACHEGLOBAL<uint128_t>, half_t>;
using TiledCopy = TiledCopy<
    CopyAtom,
    Layout<Shape<_16, _8>>,   // çº¿ç¨‹å¸ƒå±€
    Layout<Shape<_1, _8>>     // æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å€¼
>;

// ä½¿ç”¨TiledCopy
TiledCopy tiled_copy;
auto thr_copy = tiled_copy.get_slice(thread_idx);  // è·å–å½“å‰çº¿ç¨‹çš„è§†å›¾

// åˆ†åŒºæºå’Œç›®æ ‡tensor
Tensor tSgS = thr_copy.partition_S(gS);  // æºåˆ†åŒº
Tensor tSsS = thr_copy.partition_D(sS);  // ç›®æ ‡åˆ†åŒº

// æ‰§è¡Œæ‹·è´
cute::copy(tiled_copy, tSgS, tSsS);
```

```
TiledCopyç¤ºæ„å›¾ (G2S):

å…¨å±€å†…å­˜ (HBM)                    å…±äº«å†…å­˜ (SMEM)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚          â”‚                     â”‚
â”‚    æºTensor         â”‚  â”€â”€â”€â”€â”€â”€â†’ â”‚    ç›®æ ‡Tensor       â”‚
â”‚    [128Ã—64]         â”‚  cp_asyncâ”‚    [128Ã—64]         â”‚
â”‚                     â”‚          â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çº¿ç¨‹åˆ†é…:
Thread 0:  å¤„ç† [0:8, 0:8]
Thread 1:  å¤„ç† [0:8, 8:16]
Thread 2:  å¤„ç† [0:8, 16:24]
...
Thread 31: å¤„ç† [24:32, 56:64]

æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨128-bitåŠ è½½ (8ä¸ªFP16)
```

---

## 3. cute vs ä¼ ç»ŸCUDAç¼–ç¨‹

### 3.1 ä»£ç å¯¹æ¯”

```cpp
// ========================================
// ä¼ ç»ŸCUDA: æ‰‹åŠ¨è®¡ç®—ç´¢å¼•å’Œå¸ƒå±€
// ========================================

__global__ void matmul_traditional(
    half* A, half* B, float* C,
    int M, int N, int K
) {
    // æ‰‹åŠ¨è®¡ç®—çº¿ç¨‹å—å’Œçº¿ç¨‹ç´¢å¼•
    int block_row = blockIdx.y;
    int block_col = blockIdx.x;
    int thread_row = threadIdx.y;
    int thread_col = threadIdx.x;
    
    // æ‰‹åŠ¨åˆ†é…å…±äº«å†…å­˜
    __shared__ half As[TILE_M][TILE_K];
    __shared__ half Bs[TILE_K][TILE_N];
    
    // æ‰‹åŠ¨è®¡ç®—å…¨å±€åç§»
    int a_row = block_row * TILE_M + thread_row;
    int a_col = thread_col;
    
    // æ‰‹åŠ¨åŠ è½½æ•°æ®
    for (int k = 0; k < K; k += TILE_K) {
        // å¤æ‚çš„ç´¢å¼•è®¡ç®—...
        As[thread_row][thread_col] = A[a_row * K + k + a_col];
        // ...
    }
    
    // æ‰‹åŠ¨è°ƒç”¨MMA
    // éœ€è¦ç†è§£WMMA/MMAæŒ‡ä»¤çš„ç»†èŠ‚
    // ...
}

// ========================================
// cute: å£°æ˜å¼çš„æŠ½è±¡
// ========================================

__global__ void matmul_cute(
    half* A_ptr, half* B_ptr, float* C_ptr,
    int M, int N, int K
) {
    using namespace cute;
    
    // å£°æ˜å¼åœ°åˆ›å»ºTensor
    Tensor mA = make_tensor(make_gmem_ptr(A_ptr), 
                             make_layout(make_shape(M, K)));
    Tensor mB = make_tensor(make_gmem_ptr(B_ptr),
                             make_layout(make_shape(K, N)));
    Tensor mC = make_tensor(make_gmem_ptr(C_ptr),
                             make_layout(make_shape(M, N)));
    
    // å®šä¹‰TiledMMA
    TiledMma tiled_mma = make_tiled_mma(SM80_16x8x16_F32F16F16F32_TN{});
    
    // è·å–å½“å‰çº¿ç¨‹çš„è§†å›¾
    auto thr_mma = tiled_mma.get_slice(threadIdx.x);
    
    // cuteè‡ªåŠ¨å¤„ç†ç´¢å¼•è®¡ç®—ã€æ•°æ®å¸ƒå±€å’ŒMMAè°ƒç”¨
    // ...
}
```

### 3.2 ä¼˜åŠ¿å¯¹æ¯”

| æ–¹é¢ | ä¼ ç»ŸCUDA | cute |
|------|----------|------|
| **ä»£ç é‡** | å¤š | å°‘ |
| **å¯è¯»æ€§** | ä½ï¼ˆå……æ»¡é­”æ³•æ•°å­—ï¼‰ | é«˜ï¼ˆå£°æ˜å¼ï¼‰ |
| **å¯ç»´æŠ¤æ€§** | ä½ | é«˜ |
| **æ˜“å‡ºé”™** | é«˜ï¼ˆç´¢å¼•è®¡ç®—å®¹æ˜“é”™ï¼‰ | ä½ï¼ˆç±»å‹å®‰å…¨ï¼‰ |
| **å¯ç»„åˆ** | å·® | å¥½ |
| **æ€§èƒ½** | å–å†³äºä¼˜åŒ–ç¨‹åº¦ | æ¥è¿‘æœ€ä¼˜ |

---

## 4. å¸¸è§cuteæ“ä½œ

### 4.1 Tensoræ“ä½œ

```cpp
// 1. åˆ›å»ºTensor
Tensor gQ = make_tensor(make_gmem_ptr(ptr), shape, stride);
Tensor sQ = make_tensor(make_smem_ptr(smem_ptr), layout);

// 2. è·å–å±€éƒ¨Tile
//    ä»å¤§Tensorä¸­è·å–ä¸€ä¸ªå°çš„è§†å›¾
Tensor tile = local_tile(gQ, tile_shape, tile_coord);
// ä¾‹: ä» [2048, 64] çš„ gQ ä¸­è·å– [128, 64] çš„ä¸€å—

// 3. è·å–åˆ†åŒº
//    ç”¨äºå¤šçº¿ç¨‹å¹¶è¡Œ
Tensor tQgQ = thr_copy.partition_S(gQ);  // æºåˆ†åŒº
Tensor tQsQ = thr_copy.partition_D(sQ);  // ç›®æ ‡åˆ†åŒº

// 4. é‡å¡‘
Tensor reshaped = group_modes<0,2>(tensor);  // åˆå¹¶ç»´åº¦
```

### 4.2 æ‹·è´æ“ä½œ

```cpp
// åŒæ­¥æ‹·è´
cute::copy(src_tensor, dst_tensor);

// å¼‚æ­¥æ‹·è´ï¼ˆéœ€è¦é…åˆfenceå’Œwaitï¼‰
cute::copy(Copy_Atom<SM80_CP_ASYNC>{}, src, dst);
cute::cp_async_fence();    // æ’å…¥fence
cute::cp_async_wait<0>();  // ç­‰å¾…å®Œæˆ

// ä½¿ç”¨TiledCopy
auto tiled_copy = make_tiled_copy(...);
auto thr_copy = tiled_copy.get_slice(thread_idx);
cute::copy(tiled_copy, thr_copy.partition_S(src), thr_copy.partition_D(dst));
```

### 4.3 MMAæ“ä½œ

```cpp
// åˆ›å»ºTiledMMA
auto tiled_mma = make_tiled_mma(SM80_16x8x16_F32F16F16F32_TN{});
auto thr_mma = tiled_mma.get_slice(thread_idx);

// åˆ†åŒºè¾“å…¥å’Œè¾“å‡º
Tensor tCrA = thr_mma.partition_A(sA);  // Açš„å¯„å­˜å™¨åˆ†åŒº
Tensor tCrB = thr_mma.partition_B(sB);  // Bçš„å¯„å­˜å™¨åˆ†åŒº
Tensor tCrC = thr_mma.partition_C(mC);  // Cçš„å¯„å­˜å™¨åˆ†åŒº

// æ‰§è¡ŒçŸ©é˜µä¹˜ç´¯åŠ 
cute::gemm(tiled_mma, tCrA, tCrB, tCrC);
```

---

## 5. cuteåœ¨FlashAttentionä¸­çš„åº”ç”¨

### 5.1 Qã€Kã€Vå¼ é‡è¡¨ç¤º

```cpp
// FlashAttentionä¸­çš„å…¸å‹Tensorå®šä¹‰

// å…¨å±€å†…å­˜ä¸­çš„QçŸ©é˜µ
Tensor mQ = make_tensor(
    make_gmem_ptr(params.q_ptr),
    make_layout(
        make_shape(params.seqlen_q, params.d),  // [N, d]
        make_stride(params.d, Int<1>{})         // è¡Œä¼˜å…ˆ
    )
);

// å…±äº«å†…å­˜ä¸­çš„Qå—
extern __shared__ char smem[];
Tensor sQ = make_tensor(
    make_smem_ptr(reinterpret_cast<half_t*>(smem)),
    SmemLayoutQ{}  // é¢„å®šä¹‰çš„å…±äº«å†…å­˜å¸ƒå±€
);
```

### 5.2 åˆ†å—åŠ è½½

```cpp
// åŠ è½½ä¸€ä¸ªQçš„tileåˆ°å…±äº«å†…å­˜

// å®šä¹‰TiledCopy
using GmemCopyAtom = Copy_Atom<SM80_CP_ASYNC_CACHEGLOBAL<uint128_t>, half_t>;
using GmemTiledCopy = TiledCopy<GmemCopyAtom, ...>;

// è·å–å½“å‰çº¿ç¨‹çš„æ‹·è´è§†å›¾
auto gmem_thr_copy = GmemTiledCopy{}.get_slice(threadIdx.x);

// åˆ†åŒº
Tensor tQgQ = gmem_thr_copy.partition_S(gQ);  // å…¨å±€å†…å­˜Qçš„åˆ†åŒº
Tensor tQsQ = gmem_thr_copy.partition_D(sQ);  // å…±äº«å†…å­˜Qçš„åˆ†åŒº

// å¼‚æ­¥æ‹·è´
cute::copy(GmemTiledCopy{}, tQgQ, tQsQ);
```

### 5.3 Attentionè®¡ç®—

```cpp
// FlashAttentionä¸­çš„æ ¸å¿ƒè®¡ç®—

// 1. S = Q @ K^T
Tensor acc_s = make_fragment_like(tiled_mma);  // ç´¯åŠ å™¨
cute::gemm(tiled_mma, tQsQ, tKsK, acc_s);      // S += Q @ K^T

// 2. å¯¹Såº”ç”¨softmaxï¼ˆåœ¨å¯„å­˜å™¨ä¸­å®Œæˆï¼‰
// ... online softmax ...

// 3. O = P @ V
cute::gemm(tiled_mma, tPsP, tVsV, acc_o);      // O += P @ V
```

---

## 6. å…³é”®æœ¯è¯­

| æœ¯è¯­ | è‹±æ–‡ | å«ä¹‰ |
|------|------|------|
| Layout | - | æè¿°æ•°æ®åœ¨å†…å­˜ä¸­çš„æ’å¸ƒ |
| Shape | - | å¼ é‡æ¯ä¸ªç»´åº¦çš„å¤§å° |
| Stride | - | ç›¸é‚»å…ƒç´ åœ¨å†…å­˜ä¸­çš„è·ç¦» |
| Tensor | - | æ•°æ®æŒ‡é’ˆ + Layoutçš„ç»„åˆ |
| TiledMMA | - | åˆ†å—çŸ©é˜µä¹˜ç´¯åŠ æŠ½è±¡ |
| TiledCopy | - | åˆ†å—å†…å­˜æ‹·è´æŠ½è±¡ |
| Partition | - | å°†Tensoråˆ†é…ç»™çº¿ç¨‹ |
| local_tile | - | è·å–Tensorçš„å±€éƒ¨è§†å›¾ |
| Fragment | - | å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­çš„Tensor |

---

## 7. æ€»ç»“

### 7.1 cuteçš„æ ¸å¿ƒä»·å€¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cuteæ ¸å¿ƒä»·å€¼                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. ç»Ÿä¸€çš„æŠ½è±¡                                                   â”‚
â”‚     â””â”€â”€ ç”¨ç›¸åŒçš„æ–¹å¼è¡¨ç¤ºHBMã€SMEMã€å¯„å­˜å™¨ä¸­çš„æ•°æ®               â”‚
â”‚                                                                  â”‚
â”‚  2. å£°æ˜å¼ç¼–ç¨‹                                                   â”‚
â”‚     â””â”€â”€ æè¿°"æ˜¯ä»€ä¹ˆ"è€Œä¸æ˜¯"æ€ä¹ˆåš"                              â”‚
â”‚                                                                  â”‚
â”‚  3. å¯ç»„åˆæ€§                                                     â”‚
â”‚     â””â”€â”€ å°çš„æŠ½è±¡ç»„åˆæˆå¤æ‚æ“ä½œ                                  â”‚
â”‚                                                                  â”‚
â”‚  4. é›¶å¼€é”€æŠ½è±¡                                                   â”‚
â”‚     â””â”€â”€ ç¼–è¯‘æœŸè§£æï¼Œè¿è¡Œæ—¶æ— é¢å¤–å¼€é”€                            â”‚
â”‚                                                                  â”‚
â”‚  5. ç±»å‹å®‰å…¨                                                     â”‚
â”‚     â””â”€â”€ ç¼–è¯‘æœŸæ£€æŸ¥å¸ƒå±€å…¼å®¹æ€§                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 FlashAttentionä¸ºä½•ä½¿ç”¨cute

1. **ç®€åŒ–ä»£ç **ï¼šç›¸æ¯”ä¼ ç»ŸCUDAï¼Œä»£ç é‡å¤§å¹…å‡å°‘
2. **æé«˜å¯ç»´æŠ¤æ€§**ï¼šå£°æ˜å¼ä»£ç æ›´å®¹æ˜“ç†è§£å’Œä¿®æ”¹
3. **ä¿æŒæ€§èƒ½**ï¼šæŠ½è±¡ä¸å¼•å…¥è¿è¡Œæ—¶å¼€é”€
4. **æ”¯æŒæœ€æ–°ç¡¬ä»¶**ï¼šè‡ªåŠ¨åˆ©ç”¨Tensor Coreã€å¼‚æ­¥æ‹·è´ç­‰ç‰¹æ€§

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [cuteå®˜æ–¹æ•™ç¨‹](https://github.com/NVIDIA/cutlass/blob/main/media/docs/cute/00_quickstart.md)ï¼šå¿«é€Ÿå…¥é—¨
- [cute Layoutè¯¦è§£](https://github.com/NVIDIA/cutlass/blob/main/media/docs/cute/01_layout.md)ï¼šæ·±å…¥ç†è§£Layout
- [cute MMA](https://github.com/NVIDIA/cutlass/blob/main/media/docs/cute/0t_mma_atom.md)ï¼šMMAæŠ½è±¡è¯¦è§£
- [CUTLASS cuteç¤ºä¾‹](https://github.com/NVIDIA/cutlass/tree/main/examples/cute)ï¼šå®é™…ä»£ç ç¤ºä¾‹



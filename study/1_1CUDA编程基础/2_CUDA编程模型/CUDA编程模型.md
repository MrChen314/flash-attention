# CUDAç¼–ç¨‹æ¨¡å‹

> Grid â†’ Block â†’ Thread ä¸‰å±‚çº¿ç¨‹ç»„ç»‡ç»“æ„

---

## 1. CUDAç¼–ç¨‹æ¨¡å‹æ¦‚è¿°

CUDAç¼–ç¨‹æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯**å°†è®¡ç®—ä»»åŠ¡åˆ†è§£ä¸ºå¤§é‡å¹¶è¡Œçš„çº¿ç¨‹**ã€‚è¿™äº›çº¿ç¨‹è¢«ç»„ç»‡æˆä¸€ä¸ªå±‚æ¬¡ç»“æ„ï¼š

```
Grid (ç½‘æ ¼)
  â””â”€â”€ Block (çº¿ç¨‹å—)
        â””â”€â”€ Thread (çº¿ç¨‹)
```

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦å±‚æ¬¡ç»“æ„ï¼Ÿ

1. **å¯æ‰©å±•æ€§**ï¼šåŒä¸€æ®µä»£ç å¯ä»¥åœ¨ä¸åŒè§„æ¨¡çš„GPUä¸Šè¿è¡Œ
2. **èµ„æºç®¡ç†**ï¼šBlockæ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼ˆå…±äº«å†…å­˜ã€å¯„å­˜å™¨ï¼‰
3. **åŒæ­¥æœºåˆ¶**ï¼šBlockå†…çº¿ç¨‹å¯ä»¥åŒæ­¥ï¼ŒBlockä¹‹é—´ç‹¬ç«‹æ‰§è¡Œ

---

## 2. Kernelå‡½æ•°

### 2.1 ä»€ä¹ˆæ˜¯Kernel

Kernelæ˜¯åœ¨GPUä¸Šæ‰§è¡Œçš„å‡½æ•°ï¼Œç”±å¤§é‡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚

```cpp
// å®šä¹‰Kernelå‡½æ•°
__global__ void myKernel(float* data, int n) {
    int idx = blockIdx.x * blockDim.x + threadIdx.x;
    if (idx < n) {
        data[idx] *= 2.0f;
    }
}

// è°ƒç”¨Kernel
myKernel<<<numBlocks, threadsPerBlock>>>(data, n);
```

### 2.2 å‡½æ•°ç±»å‹é™å®šç¬¦

| é™å®šç¬¦ | æ‰§è¡Œä½ç½® | è°ƒç”¨ä½ç½® | è¯´æ˜ |
|--------|----------|----------|------|
| `__global__` | GPU | CPUæˆ–GPU | Kernelå‡½æ•° |
| `__device__` | GPU | GPU | è®¾å¤‡å‡½æ•°ï¼Œåªèƒ½è¢«Kernelæˆ–å…¶ä»–`__device__`å‡½æ•°è°ƒç”¨ |
| `__host__` | CPU | CPU | æ™®é€šCPUå‡½æ•°ï¼ˆé»˜è®¤ï¼‰ |
| `__host__ __device__` | ä¸¤è€… | ä¸¤è€… | å¯åœ¨CPUå’ŒGPUä¸Šç¼–è¯‘æ‰§è¡Œ |

---

## 3. çº¿ç¨‹å±‚æ¬¡ç»“æ„

### 3.1 Threadï¼ˆçº¿ç¨‹ï¼‰

- æœ€å°çš„æ‰§è¡Œå•å…ƒ
- æ¯ä¸ªçº¿ç¨‹æœ‰å”¯ä¸€çš„ç´¢å¼•ï¼š`threadIdx.x`, `threadIdx.y`, `threadIdx.z`
- å¯ä»¥æ˜¯1Dã€2Dæˆ–3Dç»„ç»‡

### 3.2 Blockï¼ˆçº¿ç¨‹å—ï¼‰

- ä¸€ç»„çº¿ç¨‹çš„é›†åˆ
- åŒä¸€Blockçš„çº¿ç¨‹ï¼š
  - å…±äº«Shared Memory
  - å¯ä»¥åŒæ­¥ï¼ˆ`__syncthreads()`ï¼‰
  - åœ¨åŒä¸€ä¸ªSMä¸Šæ‰§è¡Œ
- Blockæœ‰å”¯ä¸€ç´¢å¼•ï¼š`blockIdx.x`, `blockIdx.y`, `blockIdx.z`
- ç»´åº¦ç”±`blockDim.x/y/z`è¡¨ç¤º

### 3.3 Gridï¼ˆç½‘æ ¼ï¼‰

- æ‰€æœ‰Blockçš„é›†åˆ
- ç»´åº¦ç”±`gridDim.x/y/z`è¡¨ç¤º
- Blockä¹‹é—´**ç‹¬ç«‹æ‰§è¡Œ**ï¼Œæ— æ³•ç›´æ¥åŒæ­¥

### 3.4 å›¾è§£ï¼šä¸‰å±‚ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Grid (gridDim.x=3, gridDim.y=2)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Block(0,0)     â”‚ â”‚    Block(1,0)     â”‚ â”‚    Block(2,0)     â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚T00â”‚T10â”‚T20â”‚T30â”‚ â”‚ â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚ â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤ â”‚ â”‚ â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤ â”‚ â”‚ â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤ â”‚  â”‚
â”‚  â”‚ â”‚T01â”‚T11â”‚T21â”‚T31â”‚ â”‚ â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚ â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚ blockDim=(4,2)    â”‚ â”‚                   â”‚ â”‚                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Block(0,1)     â”‚ â”‚    Block(1,1)     â”‚ â”‚    Block(2,1)     â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚ â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚ â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤ â”‚ â”‚ â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤ â”‚ â”‚ â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤ â”‚  â”‚
â”‚  â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚ â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚ â”‚ â”‚   â”‚   â”‚   â”‚   â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…¶ä¸­ T_xy è¡¨ç¤º threadIdx.x=x, threadIdx.y=y çš„çº¿ç¨‹
```

---

## 4. å†…ç½®å˜é‡

### 4.1 çº¿ç¨‹ç´¢å¼•å˜é‡

| å˜é‡ | ç±»å‹ | å«ä¹‰ |
|------|------|------|
| `threadIdx.x/y/z` | `uint3` | çº¿ç¨‹åœ¨Blockå†…çš„ç´¢å¼• |
| `blockIdx.x/y/z` | `uint3` | Blockåœ¨Gridå†…çš„ç´¢å¼• |
| `blockDim.x/y/z` | `dim3` | Blockçš„ç»´åº¦ï¼ˆæ¯ä¸ªBlockæœ‰å¤šå°‘çº¿ç¨‹ï¼‰ |
| `gridDim.x/y/z` | `dim3` | Gridçš„ç»´åº¦ï¼ˆæœ‰å¤šå°‘Blockï¼‰ |

### 4.2 è®¡ç®—å…¨å±€çº¿ç¨‹ç´¢å¼•

#### 1Dæƒ…å†µ

```cpp
int globalIdx = blockIdx.x * blockDim.x + threadIdx.x;
```

```
Grid: [Block0][Block1][Block2][Block3]
        â†“       â†“       â†“       â†“
       [0-3]  [4-7]  [8-11] [12-15]  (å‡è®¾blockDim.x=4)
       
Block 2, Thread 1çš„å…¨å±€ç´¢å¼• = 2 * 4 + 1 = 9
```

#### 2Dæƒ…å†µ

```cpp
int globalX = blockIdx.x * blockDim.x + threadIdx.x;
int globalY = blockIdx.y * blockDim.y + threadIdx.y;
// çº¿æ€§åŒ–
int globalIdx = globalY * (gridDim.x * blockDim.x) + globalX;
```

#### 3Dæƒ…å†µ

```cpp
int globalX = blockIdx.x * blockDim.x + threadIdx.x;
int globalY = blockIdx.y * blockDim.y + threadIdx.y;
int globalZ = blockIdx.z * blockDim.z + threadIdx.z;
```

---

## 5. Kernelå¯åŠ¨é…ç½®

### 5.1 è¯­æ³•

```cpp
kernel<<<gridDim, blockDim, sharedMem, stream>>>(args...);
```

| å‚æ•° | å«ä¹‰ | é»˜è®¤å€¼ |
|------|------|--------|
| `gridDim` | Gridçš„ç»´åº¦ï¼ˆBlockæ•°é‡ï¼‰ | å¿…éœ€ |
| `blockDim` | Blockçš„ç»´åº¦ï¼ˆçº¿ç¨‹æ•°é‡ï¼‰ | å¿…éœ€ |
| `sharedMem` | åŠ¨æ€å…±äº«å†…å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰ | 0 |
| `stream` | CUDAæµ | é»˜è®¤æµ |

### 5.2 ä½¿ç”¨dim3

```cpp
// 1Dé…ç½®
kernel<<<numBlocks, threadsPerBlock>>>(args);

// 2Dé…ç½®
dim3 gridDim(gridX, gridY);
dim3 blockDim(blockX, blockY);
kernel<<<gridDim, blockDim>>>(args);

// 3Dé…ç½®
dim3 gridDim(gridX, gridY, gridZ);
dim3 blockDim(blockX, blockY, blockZ);
kernel<<<gridDim, blockDim>>>(args);
```

### 5.3 å¸¸è§é…ç½®æ¨¡å¼

**å¤„ç†1Dæ•°ç»„ï¼š**
```cpp
int n = 1000000;
int threadsPerBlock = 256;
int numBlocks = (n + threadsPerBlock - 1) / threadsPerBlock;
kernel<<<numBlocks, threadsPerBlock>>>(data, n);
```

**å¤„ç†2DçŸ©é˜µï¼š**
```cpp
int width = 1024, height = 768;
dim3 blockDim(16, 16);  // 256çº¿ç¨‹/Block
dim3 gridDim((width + 15) / 16, (height + 15) / 16);
matrixKernel<<<gridDim, blockDim>>>(matrix, width, height);
```

---

## 6. çº¿ç¨‹é…ç½®é™åˆ¶

### 6.1 ç¡¬ä»¶é™åˆ¶ï¼ˆä»¥Ampereæ¶æ„ä¸ºä¾‹ï¼‰

| é™åˆ¶é¡¹ | æœ€å¤§å€¼ |
|--------|--------|
| æ¯Blockæœ€å¤§çº¿ç¨‹æ•° | 1024 |
| blockDim.x æœ€å¤§å€¼ | 1024 |
| blockDim.y æœ€å¤§å€¼ | 1024 |
| blockDim.z æœ€å¤§å€¼ | 64 |
| gridDim.x æœ€å¤§å€¼ | 2Â³Â¹ - 1 |
| gridDim.y æœ€å¤§å€¼ | 65535 |
| gridDim.z æœ€å¤§å€¼ | 65535 |

### 6.2 é€‰æ‹©Blockå¤§å°çš„å»ºè®®

1. **æ˜¯32çš„å€æ•°**ï¼šä¿æŒWarpå®Œæ•´
2. **é€šå¸¸é€‰æ‹©128ã€256æˆ–512**ï¼šå¹³è¡¡Occupancy
3. **è€ƒè™‘å…±äº«å†…å­˜å’Œå¯„å­˜å™¨ä½¿ç”¨**ï¼šå½±å“æ¯SMèƒ½è¿è¡Œçš„Blockæ•°

```cpp
// å¥½çš„é€‰æ‹©
dim3 blockDim(256);      // 1D
dim3 blockDim(16, 16);   // 2D, 256çº¿ç¨‹
dim3 blockDim(8, 8, 4);  // 3D, 256çº¿ç¨‹

// ä¸å¥½çš„é€‰æ‹©
dim3 blockDim(100);      // ä¸æ˜¯32çš„å€æ•°
dim3 blockDim(50, 50);   // 2500 > 1024ï¼Œè¶…è¿‡é™åˆ¶
```

---

## 7. å…¸å‹ä»£ç æ¨¡å¼

### 7.1 å‘é‡åŠ æ³•ï¼ˆ1Dï¼‰

```cpp
__global__ void vectorAdd(float* a, float* b, float* c, int n) {
    int idx = blockIdx.x * blockDim.x + threadIdx.x;
    if (idx < n) {
        c[idx] = a[idx] + b[idx];
    }
}

// è°ƒç”¨
int n = 1000000;
int blockSize = 256;
int gridSize = (n + blockSize - 1) / blockSize;
vectorAdd<<<gridSize, blockSize>>>(a, b, c, n);
```

### 7.2 çŸ©é˜µæ“ä½œï¼ˆ2Dï¼‰

```cpp
__global__ void matrixAdd(float* A, float* B, float* C, int width, int height) {
    int col = blockIdx.x * blockDim.x + threadIdx.x;
    int row = blockIdx.y * blockDim.y + threadIdx.y;
    
    if (col < width && row < height) {
        int idx = row * width + col;
        C[idx] = A[idx] + B[idx];
    }
}

// è°ƒç”¨
dim3 blockDim(16, 16);
dim3 gridDim((width + 15) / 16, (height + 15) / 16);
matrixAdd<<<gridDim, blockDim>>>(A, B, C, width, height);
```

### 7.3 3Dæ•°æ®å¤„ç†

```cpp
__global__ void volume3D(float* data, int dimX, int dimY, int dimZ) {
    int x = blockIdx.x * blockDim.x + threadIdx.x;
    int y = blockIdx.y * blockDim.y + threadIdx.y;
    int z = blockIdx.z * blockDim.z + threadIdx.z;
    
    if (x < dimX && y < dimY && z < dimZ) {
        int idx = z * dimY * dimX + y * dimX + x;
        data[idx] = x + y + z;
    }
}
```

---

## 8. ä¸FlashAttentionçš„å…³è”

FlashAttentionå¦‚ä½•ç»„ç»‡çº¿ç¨‹ï¼š

```cpp
// FlashAttentionçš„å…¸å‹Blocké…ç½®
// æ¯ä¸ªBlockå¤„ç†ä¸€ä¸ªQçš„tileå’Œå¤šä¸ªK/Vçš„tile

// Gridé…ç½®:
// - blockIdx.x: Qåºåˆ—çš„å—ç´¢å¼• (m_block)
// - blockIdx.y: batchç´¢å¼•
// - blockIdx.z: headç´¢å¼•

// Blocké…ç½®:
// - é€šå¸¸128ä¸ªçº¿ç¨‹ (4ä¸ªWarp)
// - ä½¿ç”¨Warpçº§åˆ«çš„åä½œå®ŒæˆçŸ©é˜µè¿ç®—
```

FlashAttentionä¸­çš„å…³é”®ç´¢å¼•è®¡ç®—ï¼š
```cpp
const int m_block = blockIdx.x;  // Qçš„å—ç´¢å¼•
const int bidb = blockIdx.y;      // batchç´¢å¼•
const int bidh = blockIdx.z;      // headç´¢å¼•
const int tidx = threadIdx.x;     // çº¿ç¨‹åœ¨Blockå†…çš„ç´¢å¼•
```

---

## 9. æ€»ç»“

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| Grid | æ‰€æœ‰Blockçš„é›†åˆï¼Œå¯¹åº”æ•´ä¸ªè®¡ç®—ä»»åŠ¡ |
| Block | ä¸€ç»„å¯ä»¥åŒæ­¥çš„çº¿ç¨‹ï¼Œå…±äº«å…±äº«å†…å­˜ |
| Thread | æœ€å°æ‰§è¡Œå•ä½ï¼Œæœ‰å”¯ä¸€ç´¢å¼• |
| `<<<gridDim, blockDim>>>` | Kernelå¯åŠ¨é…ç½®è¯­æ³• |
| å…¨å±€ç´¢å¼• | `blockIdx.x * blockDim.x + threadIdx.x` |

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [CUDA C++ Programming Guide - Thread Hierarchy](https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#thread-hierarchy)
- [CUDA Best Practices Guide](https://docs.nvidia.com/cuda/cuda-c-best-practices-guide/)

